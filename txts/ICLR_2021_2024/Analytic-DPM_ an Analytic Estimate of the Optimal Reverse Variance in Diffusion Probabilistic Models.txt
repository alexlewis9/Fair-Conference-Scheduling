Published as a conference paper at ICLR 2022
ANALYTIC-DPM: AN ANALYTIC ESTIMATE OF THE
OPTIMAL REVERSE VARIANCE IN DIFFUSION PROB-
ABILISTIC MODELS
Fan Bao1 ∗, Chongxuan Li2 3 †, Jun Zhu1 †, Bo Zhang1
1Dept. of Comp. Sci. & Tech., Institute for AI, Tsinghua-Huawei Joint Center for AI
BNRist Center, State Key Lab for Intell. Tech. & Sys., Tsinghua University, Beijing, China
2Gaoling School of Artiﬁcial Intelligence, Renmin University of China, Beijing, China
3Beijing Key Laboratory of Big Data Management and Analysis Methods , Beijing, China
bf19@mails.tsinghua.edu.cn,chongxuanli1991@gmail.com,
{dcszj, dcszb}@tsinghua.edu.cn
ABSTRACT
Diffusion probabilistic models (DPMs) represent a class of powerful generative
models. Despite their success, the inference of DPMs is expensive since it gener-
ally needs to iterate over thousands of timesteps. A key problem in the inference
is to estimate the variance in each timestep of the reverse process. In this work,
we present a surprising result that both the optimal reverse variance and the cor-
responding optimal KL divergence of a DPM have analytic forms w.r.t. its score
function. Building upon it, we propose Analytic-DPM, a training-free inference
framework that estimates the analytic forms of the variance and KL divergence
using the Monte Carlo method and a pretrained score-based model. Further, to
correct the potential bias caused by the score-based model, we derive both lower
and upper bounds of the optimal variance and clip the estimate for a better result.
Empirically, our analytic-DPM improves the log-likelihood of various DPMs, pro-
duces high-quality samples, and meanwhile enjoys a 20× to 80× speed up.
1
INTRODUCTION
A diffusion process gradually adds noise to a data distribution over a series of timesteps. By learning
to reverse it, diffusion probabilistic models (DPMs) (Sohl-Dickstein et al., 2015; Ho et al., 2020;
Song et al., 2020b) deﬁne a data generative process. Recently, it is shown that DPMs are able
to produce high-quality samples (Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2020b;
Dhariwal & Nichol, 2021), which are comparable or even superior to the current state-of-the-art
GAN models (Goodfellow et al., 2014; Brock et al., 2018; Wu et al., 2019; Karras et al., 2020b).
Despite their success, the inference of DPMs (e.g., sampling and density evaluation) often requires
to iterate over thousands of timesteps, which is two or three orders of magnitude slower (Song et al.,
2020a) than other generative models such as GANs. A key problem in the inference is to estimate
the variance in each timestep of the reverse process. Most of the prior works use a handcrafted
value for all timesteps, which usually run a long chain to obtain a reasonable sample and density
value (Nichol & Dhariwal, 2021). Nichol & Dhariwal (2021) attempt to improve the efﬁciency of
sampling by learning a variance network in the reverse process. However, it still needs a relatively
long trajectory to get a reasonable log-likelihood (see Appendix E in Nichol & Dhariwal (2021)).
In this work, we present a surprising result that both the optimal reverse variance and the corre-
sponding optimal KL divergence of a DPM have analytic forms w.r.t. its score function (i.e., the
gradient of a log density). Building upon it, we propose Analytic-DPM, a training-free inference
framework to improve the efﬁciency of a pretrained DPM while achieving comparable or even su-
perior performance. Analytic-DPM estimates the analytic forms of the variance and KL divergence
using the Monte Carlo method and the score-based model in the pretrained DPM. The correspond-
ing trajectory is calculated via a dynamic programming algorithm (Watson et al., 2021). Further, to
∗Work done during an internship at Huawei Noah’s Ark Lab.
†Correspondence to: C. Li and J. Zhu.
1

Published as a conference paper at ICLR 2022
correct the potential bias caused by the score-based model, we derive both lower and upper bounds
of the optimal variance and clip its estimate for a better result. Finally, we reveal an interesting
relationship between the score function and the data covariance matrix.
Analytic-DPM is applicable to a variety of DPMs (Ho et al., 2020; Song et al., 2020a; Nichol &
Dhariwal, 2021) in a plug-and-play manner. Empirically, Analytic-DPM consistently improves the
log-likelihood of these DPMs and meanwhile enjoys a 20× to 40× speed up. Besides, Analytic-
DPM also consistently improves the sample quality of DDIMs (Song et al., 2020a) and requires
up to 50 timesteps (which is a 20× to 80× speed up compared to the full timesteps) to achieve a
comparable FID to the corresponding baseline.
2
BACKGROUND
Diffusion probabilistic models (DPMs) ﬁrstly construct a forward process q(x1:N|x0) that injects
noise to a data distribution q(x0), and then reverse the forward process to recover it. Given a forward
noise schedule βn ∈(0, 1), n = 1, · · · , N, denoising diffusion probabilistic models (DDPMs) (Ho
et al., 2020) consider a Markov forward process:
qM(x1:N|x0) =
N
Y
n=1
qM(xn|xn−1),
qM(xn|xn−1) = N(xn|√αnxn−1, βnI),
(1)
where I is the identity matrix, αn and βn are scalars and αn := 1−βn. Song et al. (2020a) introduce
a more general non-Markov process indexed by a non-negative vector λ = (λ1, · · · , λN) ∈RN
≥0:
qλ(x1:N|x0) = qλ(xN|x0)
N
Y
n=2
qλ(xn−1|xn, x0),
(2)
qλ(xN|x0) = N(xN|√αNx0, βNI),
qλ(xn−1|xn, x0) = N(xn−1|˜µn(xn, x0), λ2
nI),
˜µn(xn, x0) =
p
αn−1x0 +
q
βn−1 −λ2n · xn −√αnx0
q
βn
.
Here αn := Qn
i=1 αi and βn := 1 −αn. Indeed, Eq. (2) includes the DDPM forward process as a
special case when λ2
n = ˜βn, where ˜βn :=
βn−1
βn βn. Another special case of Eq. (2) is the denoising
diffusion implicit model (DDIM) forward process, where λ2
n = 0. Besides, we can further derive
qλ(xn|x0) = N(xn|√αnx0, βnI), which is independent of λ. In the rest of the paper, we will
focus on the forward process in Eq. (2) since it is more general, and we will omit the index λ and
denote it as q(x1:N|x0) for simplicity.
The reverse process for Eq. (2) is deﬁned as a Markov process aimed to approximate q(x0) by
gradually denoising from the standard Gaussian distribution p(xN) = N(xN|0, I):
p(x0:N) = p(xN)
N
Y
n=1
p(xn−1|xn),
p(xn−1|xn) = N(xn−1|µn(xn), σ2
nI),
where µn(xn) is generally parameterized 1 by a time-dependent score-based model sn(xn) (Song
& Ermon, 2019; Song et al., 2020b):
µn(xn) = ˜µn

xn,
1
√αn
(xn + βnsn(xn))

.
(3)
The reverse process can be learned by optimizing a variational bound Lvb on negative log-likelihood:
Lvb =Eq
"
−log p(x0|x1)+
N
X
n=2
DKL(q(xn−1|x0, xn)||p(xn−1|xn))+DKL(q(xN|x0)||p(xN))
#
,
1Ho et al. (2020); Song et al. (2020a) parameterize µn(xn) with ˜µn(xn,
1
√αn (xn−
q
βnϵn(xn))), which
is equivalent to Eq. (3) by letting sn(xn) = −
1
√
βn
ϵn(xn).
2

Published as a conference paper at ICLR 2022
which is equivalent to optimizing the KL divergence between the forward and the reverse process:
min
{µn,σ2n}N
n=1
Lvb ⇔
min
{µn,σ2n}N
n=1
DKL(q(x0:N)||p(x0:N)).
(4)
To improve the sample quality in practice, instead of directly optimizing Lvb, Ho et al. (2020)
consider a reweighted variant of Lvb to learn sn(xn):
min
{sn}N
n=1
EnβnEqn(xn)||sn(xn) −∇xn log qn(xn)||2 = En,x0,ϵ||ϵ +
q
βnsn(xn)||2 + c,
(5)
where n is uniform between 1 and N, qn(xn) is the marginal distribution of the forward process
at timestep n, ϵ is a standard Gaussian noise, xn on the right-hand side is reparameterized by
xn = √αnx0+
q
βnϵ and c is a constant only related to q. Indeed, Eq. (5) is exactly a weighted sum
of score matching objectives (Song & Ermon, 2019), which admits an optimal solution s∗
n(xn) =
∇xn log qn(xn) for all n ∈{1, 2 · · · , N}.
Note that Eq. (5) provides no learning signal for the variance σ2
n. Indeed, σ2
n is generally handcrafted
in most of prior works. In DDPMs (Ho et al., 2020), two commonly used settings are σ2
n = βn and
σ2
n = ˜βn. In DDIMs, Song et al. (2020a) consistently use σ2
n = λ2
n. We argue that these handcrafted
values are not the true optimal solution of Eq. (4) in general, leading to a suboptimal performance.
3
ANALYTIC ESTIMATE OF THE OPTIMAL REVERSE VARIANCE
For a DPM, we ﬁrst show that both the optimal mean µ∗
n(xn) and the optimal variance σ∗2
n to Eq. (4)
have analytic forms w.r.t. the score function, which is summarized in the following Theorem 1.
Theorem 1. (Score representation of the optimal solution to Eq. (4), proof in Appendix A.2)
The optimal solution µ∗
n(xn) and σ∗2
n to Eq. (4) are
µ∗
n(xn) = ˜µn

xn,
1
√αn
(xn + βn∇xn log qn(xn))

,
(6)
σ∗2
n = λ2
n +


s
βn
αn
−
q
βn−1 −λ2n


2 
1 −βnEqn(xn)
||∇xn log qn(xn)||2
d

,
(7)
where qn(xn) is the marginal distribution of the forward process at the timestep n and d is the
dimension of the data.
The proof of Theorem 1 consists of three key steps:
• The ﬁrst step (see Lemma 9) is known as the moment matching (Minka, 2013), which
states that approximating arbitrary density by a Gaussian density under the KL divergence
is equivalent to setting the ﬁrst two moments of the two densities as the same. To our
knowledge, the connection of moment matching and DPMs has not been revealed before.
• In the second step (see Lemma 13), we carefully use the law of total variance conditioned
on x0 and convert the second moment of q(xn−1|xn) to that of q(x0|xn).
• In the third step (see Lemma 11), we surprisingly ﬁnd that the second moment of q(x0|xn)
can be represented by the score function, and we plug the score representation into the
second moment of q(xn−1|xn) to get the ﬁnal results in Theorem 1.
The results in Theorem 1 (and other results to appear later) can be further simpliﬁed for the DDPM
forward process (i.e., λ2
n = ˜βn, see Appendix D for details). Besides, we can also extend Theo-
rem 1 to DPMs with continuous timesteps (Song et al., 2020b; Kingma et al., 2021), where their
corresponding optimal mean and variance are also determined by the score function in an analytic
form (see Appendix E.1 for the extension).
Note that our analytic form of the optimal mean µ∗
n(xn) in Eq. (6) and the previous parameterization
of µn(xn) (Ho et al., 2020) in Eq. (3) coincide. The only difference is that Eq. (3) replaces the
3

Published as a conference paper at ICLR 2022
22
25
28
timestep n
2
13
2
11
2
9
2
7
variance
23
2
13
2
12
n
n
2
n
(a) Variance
22
25
28
timestep n
0.1
0.2
0.3
0.4
Lvb term 
 (bits/dim)
22
0.1
n
n
2
n
(b) Terms in Lvb
Figure 1: Comparing our analytic estimate ˆσ2
n and prior works with handcrafted variances βn and
˜βn. (a) compares the values of the variance for different timesteps. (b) compares the term in Lvb
corresponding to each timestep. The value of Lvb is the area under the corresponding curve.
score function ∇xn log qn(xn) in Eq. (6) with the score-based model sn(xn). This result explicitly
shows that Eq. (5) essentially shares the same optimal mean solution to the Lvb objective, providing
a simple and alternative perspective to prior works.
In contrast to the handcrafted strategies used in (Ho et al., 2020; Song et al., 2020a), Theorem 1
shows that the optimal reverse variance σ∗2
n can also be estimated without any extra training process
given a pretrained score-based model sn(xn). In fact, we ﬁrst estimate the expected mean squared
norm of ∇xn log qn(xn) by Γ = (Γ1, ..., ΓN), where
Γn = 1
M
M
X
m=1
||sn(xn,m)||2
d
,
xn,m
iid
∼qn(xn).
(8)
M is the number of Monte Carlo samples. We only need to calculate Γ once for a pretrained
model and reuse it in downstream computations (see Appendix H.1 for a detailed discussion of the
computation cost of Γ). Then, according to Eq. (7), we estimate σ∗2
n as follows:
ˆσ2
n = λ2
n +


s
βn
αn
−
q
βn−1 −λ2n


2
 1 −βnΓn

.
(9)
We empirically validate Theorem 1. In Figure 1 (a), we plot our analytic estimate ˆσ2
n of a DDPM
trained on CIFAR10, as well as the baselines βn and ˜βn used by Ho et al. (2020). At small timesteps,
these strategies behave differently. Figure 1 (b) shows that our ˆσ2
n outperforms the baselines for each
term of Lvb, especially at the small timesteps. We also obtain similar results on other datasets (see
Appendix G.1). Besides, we show that only a small number of Monte Carlo (MC) samples (e.g.,
M=10, 100) is required to achieve a sufﬁciently small variance caused by MC and get a similar
performance to that with a large M (see Appendix G.2). We also discuss the stochasticity of Lvb
after plugging ˆσ2
n in Appendix H.2.
3.1
BOUNDING THE OPTIMAL REVERSE VARIANCE TO REDUCE BIAS
According to Eq. (7) and Eq. (9), the bias of the analytic estimate ˆσ2
n is
|σ∗2
n −ˆσ2
n| =


s
βn
αn
−
q
βn−1 −λ2n


2
βn
|
{z
}
Coefﬁcient
|Γn −Eqn(xn)
||∇xn log qn(xn)||2
d
|
|
{z
}
Approximation error
.
(10)
Our estimate of the variance employs a score-based model sn(xn) to approximate the true score
function ∇xn log qn(xn). Thus, the approximation error in Eq. (10) is irreducible given a pretrained
model. Meanwhile, the coefﬁcient in Eq. (10) can be large if we use a shorter trajectory to sample
(see details in Section 4), potentially resulting in a large bias.
4

Published as a conference paper at ICLR 2022
To reduce the bias, we derive bounds of the optimal reverse variance σ∗2
n and clip our estimate based
on the bounds. Importantly, these bounds are unrelated to the data distribution q(x0) and hence
can be efﬁciently calculated. We ﬁrstly derive both upper and lower bounds of σ∗2
n without any
assumption about the data. Then we show another upper bound of σ∗2
n if the data distribution is
bounded. We formalize these bounds in Theorem 2.
Theorem 2. (Bounds of the optimal reverse variance, proof in Appendix A.3)
σ∗2
n has the following lower and upper bounds:
λ2
n ≤σ∗2
n ≤λ2
n +


s
βn
αn
−
q
βn−1 −λ2n


2
.
(11)
If we further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σ∗2
n can be further upper bounded by
σ∗2
n ≤λ2
n +
 
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
!2 b −a
2
2
.
(12)
Theorem 2 states that the handcrafted reverse variance λ2
n in prior works (Ho et al., 2020; Song et al.,
2020a) underestimates σ∗2
n . For instance, λ2
n = ˜βn in DDPM. We compare it with our estimate in
Figure 1 (a) and the results agree with Theorem 2. Besides, the boundedness assumption of q(x0)
is satisﬁed in many scenarios including generative modelling of images, and which upper bound
among Eq. (11) and Eq. (12) is tighter depends on n. Therefore, we clip our estimate based on the
minimum one. Further, we show theses bounds are tight numerically in Appendix G.3.
4
ANALYTIC ESTIMATION OF THE OPTIMAL TRAJECTORY
The number of full timesteps N can be large, making the inference slow in practice. Thereby, we can
construct a shorter forward process q(xτ1, · · · , xτK|x0) constrained on a trajectory 1 = τ1 < · · · <
τK = N of K timesteps (Song et al., 2020a; Nichol & Dhariwal, 2021; Watson et al., 2021), and K
can be much smaller than N to speed up the inference. Formally, the shorter process is deﬁned as
q(xτ1, · · · , xτK|x0) = q(xτK|x0) QK
k=2 q(xτk−1|xτk, x0), where
q(xτk−1|xτk, x0) = N(xτk−1|˜µτk−1|τk(xτk, x0), λ2
τk−1|τkI),
(13)
˜µτk−1|τk(xτk, x0) = pατk−1x0 +
q
βτk−1 −λ2
τk−1|τk · xτk −√ατkx0
q
βτk
.
The corresponding reverse process is p(x0, xτ1, · · · , xτK) = p(xτK) QK
k=1 p(xτk−1|xτk), where
p(xτk−1|xτk) = N(xτk−1|µτk−1|τk(xτk), σ2
τk−1|τkI).
According to Theorem 1, the mean and variance of the optimal p∗(xτk−1|xτk) in the sense of KL
minimization is
µ∗
τk−1|τk(xτk) = ˜µτk−1|τk

xτk,
1
√ατk
(xτk + βτk∇xτk log q(xτk))

,
σ∗2
τk−1|τk =λ2
τk−1|τk +


s
βτk
ατk|τk−1
−
q
βτk−1 −λ2
τk−1|τk


2
(1−βτkEq(xτk )
||∇xτk log q(xτk)||2
d
),
where ατk|τk−1 := ατk/ατk−1. According to Theorem 2, we can derive similar bounds for σ∗2
τk−1|τk
(see details in Appendix C). Similarly to Eq. (9), the estimate of σ∗2
τk−1|τk is
ˆσ2
τk−1|τk =λ2
τk−1|τk +


s
βτk
ατk|τk−1
−
q
βτk−1 −λ2
τk−1|τk


2
(1−βτkΓτk),
5

Published as a conference paper at ICLR 2022
where Γ is deﬁned in Eq. (8) and can be shared across different selections of trajectories. Based on
the optimal reverse process p∗above, we further optimize the trajectory:
min
τ1,··· ,τK DKL(q(x0, xτ1, · · · , xτK)||p∗(x0, xτ1, · · · , xτK)) = d
2
K
X
k=2
J(τk−1, τk) + c,
(14)
where J(τk−1, τk) = log(σ∗2
τk−1|τk/λ2
τk−1|τk) and c is a constant unrelated to the trajectory τ (see
proof in Appendix A.4). The KL in Eq. (14) can be decomposed into K −1 terms and each term
has an analytic form w.r.t. the score function. We view each term as a cost function J evaluated
at (τk−1, τk), and it can be efﬁciently estimated by J(τk−1, τk) ≈log(ˆσ2
τk−1|τk/λ2
τk−1|τk), which
doesn’t require any neural network computation once Γ is given. While the logarithmic function
causes bias even when the correct score function is known, it can be reduced by increasing M.
As a result, Eq. (14) is reduced to a canonical least-cost-path problem (Watson et al., 2021) on a
directed graph, where the nodes are {1, 2, · · · , N} and the edge from s to t has cost J(s, t). We
want to ﬁnd a least-cost path of K nodes starting from 1 and terminating at N. This problem
can be solved by the dynamic programming (DP) algorithm introduced by Watson et al. (2021).
We present this algorithm in Appendix B. Besides, we can also extend Eq. (14) to DPMs with
continuous timesteps (Song et al., 2020b; Kingma et al., 2021), where their corresponding optimal
KL divergences are also decomposed to terms determined by score functions. Thereby, the DP
algorithm is also applicable. See Appendix E.2 for the extension.
5
RELATIONSHIP BETWEEN THE SCORE FUNCTION AND THE DATA
COVARIANCE MATRIX
In this part, we further reveal a relationship between the score function and the data covariance
matrix. Indeed, the data covariance matrix can be decomposed to the sum of Eq(xn)Covq(x0|xn)[x0]
and Covq(xn)Eq(x0|xn)[x0], where the ﬁrst term can be represented by the score function. Further,
the second term is negligible when n is sufﬁciently large because x0 and xn are almost independent.
In such cases, the data covariance matrix is almost determined by the score function. Currently, the
relationship is purely theoretical and its practical implication is unclear. See details in Appendix A.5.
6
EXPERIMENTS
We consider the DDPM forward process (λ2
n = ˜βn) and the DDIM forward process (λ2
n = 0),
which are the two most commonly used special cases of Eq. (2). We denote our method, which
uses the analytic estimate σ2
n = ˆσ2
n, as Analytic-DPM, and explicitly call it Analytic-DDPM or
Analytic-DDIM according to which forward process is used. We compare our Analytic-DPM with
the original DDPM (Ho et al., 2020), where the reverse variance is either σ2
n = ˜βn or σ2
n = βn, as
well as the original DDIM (Song et al., 2020a), where the reverse variance is σ2
n = λ2
n = 0.
We adopt two methods to get the trajectory for both the analytic-DPM and baselines. The ﬁrst one is
even trajectory (ET) (Nichol & Dhariwal, 2021), where the timesteps are determined according to a
ﬁxed stride (see details in Appendix F.4). The second one is optimal trajectory (OT) (Watson et al.,
2021), where the timesteps are calculated via dynamic programming (see Section 4). Note that the
baselines calculate the OT based on the Lvb with their handcrafted variances (Watson et al., 2021).
We apply our Analytic-DPM to three pretrained score-based models provided by prior works (Ho
et al., 2020; Song et al., 2020a; Nichol & Dhariwal, 2021), as well as two score-based models
trained by ourselves. The pretrained score-based models are trained on CelebA 64x64 (Liu et al.,
2015), ImageNet 64x64 (Deng et al., 2009) and LSUN Bedroom (Yu et al., 2015) respectively. Our
score-based models are trained on CIFAR10 (Krizhevsky et al., 2009) with two different forward
noise schedules: the linear schedule (LS) (Ho et al., 2020) and the cosine schedule (CS) (Nichol &
Dhariwal, 2021). We denote them as CIFAR10 (LS) and CIFAR10 (CS) respectively. The number
of the full timesteps N is 4000 for ImageNet 64x64 and 1000 for other datasets. During sampling,
we only display the mean of p(x0|x1) and discard the noise following Ho et al. (2020), and we
additionally clip the noise scale σ2 of p(x1|x2) for all methods compared in Table 2 (see details in
Appendix F.2 and its ablation study in Appendix G.4). See more experimental details in Appendix F.
6

Published as a conference paper at ICLR 2022
Table 1: Negative log-likelihood (bits/dim) ↓under the DDPM forward process. We show results
under trajectories of different number of timesteps K. We select the minimum K such that analytic-
DPM can outperform the baselines with full timesteps and underline the corresponding results.
Model \ # timesteps K
10
25
50
100
200
400
1000
CIFAR10 (LS)
ET
DDPM, σ2
n = ˜βn
74.95
24.98
12.01
7.08
5.03
4.29
3.73
DDPM, σ2
n = βn
6.99
6.11
5.44
4.86
4.39
4.07
3.75
Analytic-DDPM
5.47
4.79
4.38
4.07
3.84
3.71
3.59
OT
DDPM, σ2
n = βn
5.38
4.34
3.97
3.82
3.77
3.75
3.75
Analytic-DDPM
4.11
3.68
3.61
3.59
3.59
3.59
3.59
CIFAR10 (CS)
ET
DDPM, σ2
n = ˜βn
75.96
24.94
11.96
7.04
4.95
4.19
3.60
DDPM, σ2
n = βn
6.51
5.55
4.92
4.41
4.03
3.78
3.54
Analytic-DDPM
5.08
4.45
4.09
3.83
3.64
3.53
3.42
OT
DDPM, σ2
n = βn
5.51
4.30
3.86
3.65
3.57
3.54
3.54
Analytic-DDPM
3.99
3.56
3.47
3.44
3.43
3.42
3.42
CelebA 64x64
ET
DDPM, σ2
n = ˜βn
33.42
13.09
7.14
4.60
3.45
3.03
2.71
DDPM, σ2
n = βn
6.67
5.72
4.98
4.31
3.74
3.34
2.93
Analytic-DDPM
4.54
3.89
3.48
3.16
2.92
2.79
2.66
OT
DDPM, σ2
n = βn
4.76
3.58
3.16
2.99
2.94
2.93
2.93
Analytic-DDPM
2.97
2.71
2.67
2.66
2.66
2.66
2.66
Model \ # timesteps K
25
50
100
200
400
1000
4000
ImageNet 64x64
ET
DDPM, σ2
n = ˜βn
105.87
46.25
22.02
12.10
7.59
5.04
3.89
DDPM, σ2
n = βn
5.81
5.20
4.70
4.31
4.04
3.81
3.65
Analytic-DDPM
4.78
4.42
4.15
3.95
3.81
3.69
3.61
OT
DDPM, σ2
n = βn
4.56
4.09
3.84
3.73
3.68
3.65
3.65
Analytic-DDPM
3.83
3.70
3.64
3.62
3.62
3.61
3.61
We conduct extensive experiments to demonstrate that analytic-DPM can consistently improve the
inference efﬁciency of a pretrained DPM while achieving a comparable or even superior perfor-
mance. Speciﬁcally, Section 6.1 and Section 6.2 present the likelihood and sample quality results
respectively. Additional experiments such as ablation studies can be found in Appendix G.
6.1
LIKELIHOOD RESULTS
Since λ2
n = 0 in the DDIM forward process, its variational bound Lvb is inﬁnite. Thereby, we
only consider the likelihood results under the DDPM forward process. As shown in Table 1, on all
three datasets, our Analytic-DPM consistently improves the likelihood results of the original DDPM
using both ET and OT. Remarkably, using a much shorter trajectory (i.e., a much less inference
time), Analytic-DPM with OT can still outperform the baselines. In Table 1, we select the mini-
mum K such that analytic-DPM can outperform the baselines with full timesteps and underline the
corresponding results. Speciﬁcally, analytic-DPM enjoys a 40× speed up on CIFAR10 (LS) and
ImageNet 64x64, and a 20× speed up on CIFAR10 (CS) and CelebA 64x64.
Although we mainly focus on learning-free strategies of choosing the reverse variance, we also
compare to another strong baseline that predicts the variance by a neural network (Nichol & Dhari-
wal, 2021). With full timesteps, Analytic-DPM achieves a NLL of 3.61 on ImageNet 64x64, which
is very close to 3.57 reported in Nichol & Dhariwal (2021). Besides, while Nichol & Dhariwal
(2021) report that the ET drastically reduces the log-likelihood performance of their neural-network-
parameterized variance, Analytic-DPM performs well with the ET. See details in Appendix G.6.
7

Published as a conference paper at ICLR 2022
Table 2: FID ↓under the DDPM and DDIM forward processes. All are evaluated under the even
trajectory (ET). The result with † is slightly better than 3.17 reported by Ho et al. (2020), because
we use an improved model architecture following Nichol & Dhariwal (2021).
Model \ # timesteps K
10
25
50
100
200
400
1000
CIFAR10 (LS)
DDPM, σ2
n = ˜βn
44.45
21.83
15.21
10.94
8.23
6.43
5.11
DDPM, σ2
n = βn
233.41
125.05
66.28
31.36
12.96
4.86
†3.04
Analytic-DDPM
34.26
11.60
7.25
5.40
4.01
3.62
4.03
DDIM
21.31
10.70
7.74
6.08
5.07
4.61
4.13
Analytic-DDIM
14.00
5.81
4.04
3.55
3.39
3.50
3.74
CIFAR10 (CS)
DDPM, σ2
n = ˜βn
34.76
16.18
11.11
8.38
6.66
5.65
4.92
DDPM, σ2
n = βn
205.31
84.71
37.35
14.81
5.74
3.40
3.34
Analytic-DDPM
22.94
8.50
5.50
4.45
4.04
3.96
4.31
DDIM
34.34
16.68
10.48
7.94
6.69
5.78
4.89
Analytic-DDIM
26.43
9.96
6.02
4.88
4.92
5.00
4.66
CelebA 64x64
DDPM, σ2
n = ˜βn
36.69
24.46
18.96
14.31
10.48
8.09
5.95
DDPM, σ2
n = βn
294.79
115.69
53.39
25.65
9.72
3.95
3.16
Analytic-DDPM
28.99
16.01
11.23
8.08
6.51
5.87
5.21
DDIM
20.54
13.45
9.33
6.60
4.96
4.15
3.40
Analytic-DDIM
15.62
9.22
6.13
4.29
3.46
3.38
3.13
Model \ # timesteps K
25
50
100
200
400
1000
4000
ImageNet 64x64
DDPM, σ2
n = ˜βn
29.21
21.71
19.12
17.81
17.48
16.84
16.55
DDPM, σ2
n = βn
170.28
83.86
45.04
28.39
21.38
17.58
16.38
Analytic-DDPM
32.56
22.45
18.80
17.16
16.40
16.14
16.34
DDIM
26.06
20.10
18.09
17.84
17.74
17.73
19.00
Analytic-DDIM
25.98
19.23
17.73
17.49
17.44
17.57
18.98
6.2
SAMPLE QUALITY
As for the sample quality, we consider the commonly used FID score (Heusel et al., 2017), where a
lower value indicates a better sample quality. As shown in Table 2, under trajectories of different K,
our Analytic-DDIM consistently improves the sample quality of the original DDIM. This allows us
to generate high-quality samples with less than 50 timesteps, which results in a 20× to 80× speed
up compared to the full timesteps. Indeed, in most cases, Analytic-DDIM only requires up to 50
timesteps to get a similar performance to the baselines. Besides, Analytic-DDPM also improves the
sample quality of the original DDPM in most cases. For fairness, we use the ET implementation in
Nichol & Dhariwal (2021) for all results in Table 2. We also report the results on CelebA 64x64
using a slightly different implementation of the ET following Song et al. (2020a) in Appendix G.7,
and our Analytic-DPM is still effective. We show generated samples in Appendix G.9.
We observe that Analytic-DDPM does not always outperform the baseline under the FID metric,
which is inconsistent with the likelihood results in Table 1. Such a behavior essentially roots in the
different natures of the two metrics and has been investigated in extensive prior works (Theis et al.,
2015; Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2021; Vahdat et al., 2021; Watson et al.,
2021; Kingma et al., 2021). Similarly, using more timesteps doesn’t necessarily yield a better FID.
For instance, see the Analytic-DDPM results on CIFAR10 (LS) and the DDIM results on ImageNet
64x64 in Table 2. A similar phenomenon is observed in Figure 8 in Nichol & Dhariwal (2021).
Moreover, a DPM (including Analytic-DPM) with OT does not necessarily lead to a better FID
score (Watson et al., 2021) (see Appendix G.5 for a comparison of ET and OT in Analytic-DPM).
8

Published as a conference paper at ICLR 2022
Table 3: Efﬁciency comparison, based on the least number of timesteps ↓required to achieve a FID
around 6 (with the corresponding FID). To get the strongest baseline, the results with † are achieved
by using the quadratic trajectory Song et al. (2020a) instead of the default even trajectory.
Method
CIFAR10
CelebA 64x64
LSUN Bedroom
DDPM (Ho et al., 2020)
†90 (6.12)
> 200
130 (6.06)
DDIM (Song et al., 2020a)
†30 (5.85)
> 100
Best FID > 6
Improved DDPM (Nichol & Dhariwal, 2021)
45 (5.96)
Missing model
90 (6.02)
Analytic-DPM (ours)
25 (5.81)
55 (5.98)
100 (6.05)
We summarize the efﬁciency of different methods in Table 3, where we consider the least number
of timesteps required to achieve a FID around 6 as the metric for a more direct comparison.
7
RELATED WORK
DPMs and their applications. The diffusion probabilistic model (DPM) is initially introduced by
Sohl-Dickstein et al. (2015), where the DPM is trained by optimizing the variational bound Lvb.
Ho et al. (2020) propose the new parameterization of DPMs in Eq. (3) and learn DPMs with the
reweighted variant of Lvb in Eq. (5). Song et al. (2020b) model the noise adding forward process
as a stochastic differential equation (SDE) and introduce DPMs with continuous timesteps. With
these important improvements, DPMs show great potential in various applications, including speech
synthesis (Chen et al., 2020; Kong et al., 2020; Popov et al., 2021; Lam et al., 2021), controllable
generation (Choi et al., 2021; Sinha et al., 2021), image super-resolution (Saharia et al., 2021; Li
et al., 2021), image-to-image translation (Sasaki et al., 2021), shape generation (Zhou et al., 2021)
and time series forecasting (Rasul et al., 2021).
Faster DPMs. Several works attempt to ﬁnd short trajectories while maintaining the DPM per-
formance. Chen et al. (2020) ﬁnd an effective trajectory of only six timesteps by the grid search.
However, the grid search is only applicable to very short trajectories due to its exponentially growing
time complexity. Watson et al. (2021) model the trajectory searching as a least-cost-path problem
and introduce a dynamic programming (DP) algorithm to solve this problem. Our work uses this
DP algorithm, where the cost is deﬁned as a term of the optimal KL divergence. In addition to
these trajectory searching techniques, Luhman & Luhman (2021) compress the reverse denoising
process into a single step model; San-Roman et al. (2021) dynamically adjust the trajectory dur-
ing inference. Both of them need extra training after getting a pretrained DPM. As for DPMs with
continuous timesteps (Song et al., 2020b), Song et al. (2020b) introduce an ordinary differential
equation (ODE), which improves sampling efﬁciency and enables exact likelihood computation.
However, the likelihood computation involves a stochastic trace estimator, which requires a multiple
number of runs for accurate computation. Jolicoeur-Martineau et al. (2021) introduce an advanced
SDE solver to simulate the reverse process in a more efﬁcient way. However, the log-likelihood
computation based on this solver is not speciﬁed.
Variance Learning in DPMs. In addition to the reverse variance, there are also works on learning
the forward noise schedule (i.e., the forward variance). Kingma et al. (2021) propose variational
diffusion models (VDMs) on continuous timesteps, which use a signal-to-noise ratio function to
parameterize the forward variance and directly optimize the variational bound objective for a better
log-likelihood. While we primarily apply our method to DDPMs and DDIMs, estimating the optimal
reverse variance can also be applied to VDMs (see Appendix E).
8
CONCLUSION
We present that both the optimal reverse variance and the corresponding optimal KL divergence
of a DPM have analytic forms w.r.t. its score function. Building upon it, we propose Analytic-
DPM, a training-free inference framework that estimates the analytic forms of the variance and KL
divergence using the Monte Carlo method and a pretrained score-based model. We derive bounds
of the optimal variance to correct potential bias and reveal a relationship between the score function
and the data covariance matrix. Empirically, our analytic-DPM improves both the efﬁciency and
performance of likelihood results, and generates high-quality samples efﬁciently in various DPMs.
9

Published as a conference paper at ICLR 2022
ACKNOWLEDGMENTS
This work was supported by NSF of China Projects (Nos.
62061136001, 61620106010,
62076145), Beijing NSF Project (No. JQ19016), Beijing Outstanding Young Scientist Program
NO. BJJWZYJH012019100020098, Beijing Academy of Artiﬁcial Intelligence (BAAI), Tsinghua-
Huawei Joint Research Program, a grant from Tsinghua Institute for Guo Qiang, and the NVIDIA
NVAIL Program with GPU/DGX Acceleration, Major Innovation & Planning Interdisciplinary Plat-
form for the “Double-First Class” Initiative, Renmin University of China.
ETHICS STATEMENT
This work proposes an analytic estimate of the optimal variance in the reverse process of diffusion
probabilistic models. As a fundamental research in machine learning, the negative consequences are
not obvious. Though in theory any technique can be misused, it is not likely to happen at the current
stage.
REPRODUCIBILITY STATEMENT
We provide our codes and links to pretrained models in https://github.com/baofff/
Analytic-DPM. We provide details of these pretrained models in Appendix F.1. We provide de-
tails of data processing, log-likelihood evaluation, sampling and FID computation in Appendix F.2.
We provide complete proofs of all theoretical results in Appendix A.
REFERENCES
Andrew Brock, Jeff Donahue, and Karen Simonyan. Large scale gan training for high ﬁdelity natural
image synthesis. arXiv preprint arXiv:1809.11096, 2018.
Yuri Burda, Roger Grosse, and Ruslan Salakhutdinov. Importance weighted autoencoders. arXiv
preprint arXiv:1509.00519, 2015.
Nanxin Chen, Yu Zhang, Heiga Zen, Ron J Weiss, Mohammad Norouzi, and William Chan. Wave-
grad: Estimating gradients for waveform generation. arXiv preprint arXiv:2009.00713, 2020.
Jooyoung Choi, Sungwon Kim, Yonghyun Jeong, Youngjune Gwon, and Sungroh Yoon. Ilvr: Con-
ditioning method for denoising diffusion probabilistic models. arXiv preprint arXiv:2108.02938,
2021.
Jia Deng, Wei Dong, Richard Socher, Li-Jia Li, Kai Li, and Li Fei-Fei. Imagenet: A large-scale hi-
erarchical image database. In 2009 IEEE conference on computer vision and pattern recognition,
pp. 248–255. Ieee, 2009.
Prafulla Dhariwal and Alex Nichol. Diffusion models beat gans on image synthesis. arXiv preprint
arXiv:2105.05233, 2021.
Yilun Du and Igor Mordatch. Implicit generation and generalization in energy-based models. arXiv
preprint arXiv:1903.08689, 2019.
Ian Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-Farley, Sherjil Ozair,
Aaron Courville, and Yoshua Bengio. Generative adversarial nets. Advances in neural information
processing systems, 27, 2014.
Martin Heusel, Hubert Ramsauer, Thomas Unterthiner, Bernhard Nessler, and Sepp Hochreiter.
Gans trained by a two time-scale update rule converge to a local nash equilibrium. Advances in
neural information processing systems, 30, 2017.
Jonathan Ho, Ajay Jain, and Pieter Abbeel. Denoising diffusion probabilistic models. arXiv preprint
arXiv:2006.11239, 2020.
10

Published as a conference paper at ICLR 2022
Alexia Jolicoeur-Martineau, Ke Li, R´emi Pich´e-Taillefer, Tal Kachman, and Ioannis Mitliagkas.
Gotta go fast when generating data with score-based models. arXiv preprint arXiv:2105.14080,
2021.
Tero Karras, Miika Aittala, Janne Hellsten, Samuli Laine, Jaakko Lehtinen, and Timo Aila. Training
generative adversarial networks with limited data. arXiv preprint arXiv:2006.06676, 2020a.
Tero Karras, Samuli Laine, Miika Aittala, Janne Hellsten, Jaakko Lehtinen, and Timo Aila. Analyz-
ing and improving the image quality of stylegan. In Proceedings of the IEEE/CVF Conference on
Computer Vision and Pattern Recognition, pp. 8110–8119, 2020b.
Hyun-Chul Kim and Zoubin Ghahramani. Bayesian gaussian process classiﬁcation with the em-ep
algorithm. IEEE Transactions on Pattern Analysis and Machine Intelligence, 28(12):1948–1959,
2006.
Diederik P Kingma and Prafulla Dhariwal. Glow: Generative ﬂow with invertible 1x1 convolutions.
arXiv preprint arXiv:1807.03039, 2018.
Diederik P Kingma, Tim Salimans, Ben Poole, and Jonathan Ho. Variational diffusion models.
arXiv preprint arXiv:2107.00630, 2021.
Zhifeng Kong, Wei Ping, Jiaji Huang, Kexin Zhao, and Bryan Catanzaro. Diffwave: A versatile
diffusion model for audio synthesis. arXiv preprint arXiv:2009.09761, 2020.
Alex Krizhevsky, Geoffrey Hinton, et al. Learning multiple layers of features from tiny images.
2009.
Max WY Lam, Jun Wang, Rongjie Huang, Dan Su, and Dong Yu. Bilateral denoising diffusion
models. arXiv preprint arXiv:2108.11514, 2021.
Haoying Li, Yifan Yang, Meng Chang, Huajun Feng, Zhihai Xu, Qi Li, and Yueting Chen.
Srdiff:
Single image super-resolution with diffusion probabilistic models.
arXiv preprint
arXiv:2104.14951, 2021.
Ziwei Liu, Ping Luo, Xiaogang Wang, and Xiaoou Tang. Deep learning face attributes in the wild. In
2015 IEEE International Conference on Computer Vision, ICCV 2015, Santiago, Chile, December
7-13, 2015, pp. 3730–3738. IEEE Computer Society, 2015.
Ilya Loshchilov and Frank Hutter.
Decoupled weight decay regularization.
arXiv preprint
arXiv:1711.05101, 2017.
Eric Luhman and Troy Luhman. Knowledge distillation in iterative generative models for improved
sampling speed. arXiv preprint arXiv:2101.02388, 2021.
Thomas P Minka. Expectation propagation for approximate bayesian inference. arXiv preprint
arXiv:1301.2294, 2013.
Thomas Peter Minka. A family of algorithms for approximate Bayesian inference. PhD thesis,
Massachusetts Institute of Technology, 2001.
Takeru Miyato, Toshiki Kataoka, Masanori Koyama, and Yuichi Yoshida. Spectral normalization
for generative adversarial networks. arXiv preprint arXiv:1802.05957, 2018.
Alex Nichol and Prafulla Dhariwal.
Improved denoising diffusion probabilistic models.
arXiv
preprint arXiv:2102.09672, 2021.
Vadim Popov, Ivan Vovk, Vladimir Gogoryan, Tasnima Sadekova, and Mikhail Kudinov. Grad-tts:
A diffusion probabilistic model for text-to-speech. arXiv preprint arXiv:2105.06337, 2021.
Kashif Rasul, Calvin Seward, Ingmar Schuster, and Roland Vollgraf.
Autoregressive denois-
ing diffusion models for multivariate probabilistic time series forecasting.
arXiv preprint
arXiv:2101.12072, 2021.
11

Published as a conference paper at ICLR 2022
Danilo Jimenez Rezende, Shakir Mohamed, and Daan Wierstra. Stochastic backpropagation and ap-
proximate inference in deep generative models. In International conference on machine learning,
pp. 1278–1286. PMLR, 2014.
Chitwan Saharia, Jonathan Ho, William Chan, Tim Salimans, David J Fleet, and Mohammad
Norouzi. Image super-resolution via iterative reﬁnement. arXiv preprint arXiv:2104.07636, 2021.
Robin San-Roman, Eliya Nachmani, and Lior Wolf. Noise estimation for generative diffusion mod-
els. arXiv preprint arXiv:2104.02600, 2021.
Hiroshi Sasaki, Chris G Willcocks, and Toby P Breckon. Unit-ddpm: Unpaired image translation
with denoising diffusion probabilistic models. arXiv preprint arXiv:2104.05358, 2021.
Abhishek Sinha, Jiaming Song, Chenlin Meng, and Stefano Ermon.
D2c: Diffusion-denoising
models for few-shot conditional generation. arXiv preprint arXiv:2106.06819, 2021.
Jascha Sohl-Dickstein, Eric Weiss, Niru Maheswaranathan, and Surya Ganguli. Deep unsupervised
learning using nonequilibrium thermodynamics. In International Conference on Machine Learn-
ing, pp. 2256–2265. PMLR, 2015.
Jiaming Song, Chenlin Meng, and Stefano Ermon. Denoising diffusion implicit models. arXiv
preprint arXiv:2010.02502, 2020a.
Yang Song and Stefano Ermon. Generative modeling by estimating gradients of the data distribution.
arXiv preprint arXiv:1907.05600, 2019.
Yang Song, Jascha Sohl-Dickstein, Diederik P Kingma, Abhishek Kumar, Stefano Ermon, and Ben
Poole. Score-based generative modeling through stochastic differential equations. arXiv preprint
arXiv:2011.13456, 2020b.
Yang Song, Conor Durkan, Iain Murray, and Stefano Ermon. Maximum likelihood training of score-
based diffusion models. arXiv e-prints, pp. arXiv–2101, 2021.
Lucas Theis, A¨aron van den Oord, and Matthias Bethge. A note on the evaluation of generative
models. arXiv preprint arXiv:1511.01844, 2015.
Arash Vahdat and Jan Kautz. Nvae: A deep hierarchical variational autoencoder. arXiv preprint
arXiv:2007.03898, 2020.
Arash Vahdat, Karsten Kreis, and Jan Kautz. Score-based generative modeling in latent space. arXiv
preprint arXiv:2106.05931, 2021.
Daniel Watson, Jonathan Ho, Mohammad Norouzi, and William Chan. Learning to efﬁciently sam-
ple from diffusion probabilistic models. arXiv preprint arXiv:2106.03802, 2021.
Yan Wu, Jeff Donahue, David Balduzzi, Karen Simonyan, and Timothy Lillicrap. Logan: Latent
optimisation for generative adversarial networks. arXiv preprint arXiv:1912.00953, 2019.
Zhisheng Xiao, Karsten Kreis, Jan Kautz, and Arash Vahdat. Vaebm: A symbiosis between varia-
tional autoencoders and energy-based models. In International Conference on Learning Repre-
sentations, 2020.
Fisher Yu, Yinda Zhang, Shuran Song, Ari Seff, and Jianxiong Xiao.
Lsun: Construction of
a large-scale image dataset using deep learning with humans in the loop.
arXiv preprint
arXiv:1506.03365, 2015.
Linqi Zhou, Yilun Du, and Jiajun Wu. 3d shape generation and completion through point-voxel
diffusion. arXiv preprint arXiv:2104.03670, 2021.
12

Published as a conference paper at ICLR 2022
A
PROOFS AND DERIVATIONS
A.1
LEMMAS
Lemma 1. (Cross-entropy to Gaussian) Suppose q(x) is a probability density function with mean
µq and covariance matrix Σq and p(x) = N(x|µ, Σ) is a Gaussian distribution, then the cross-
entropy between q and p is equal to the cross-entropy between N(x|µq, Σq) and p, i.e.,
H(q, p) = H(N(x|µq, Σq), p)
=1
2 log((2π)d|Σ|) + 1
2 tr(ΣqΣ−1) + 1
2(µq −µ)⊤Σ−1(µq −µ).
Proof.
H(q, p) = −Eq(x) log p(x) = −Eq(x) log
1
p
(2π)d|Σ|
exp(−(x −µ)⊤Σ−1(x −µ)
2
)
=1
2 log((2π)d|Σ|) + 1
2Eq(x)(x −µ)⊤Σ−1(x −µ)
=1
2 log((2π)d|Σ|) + 1
2Eq(x) tr((x −µ)(x −µ)⊤Σ−1)
=1
2 log((2π)d|Σ|) + 1
2 tr(Eq(x)

(x −µ)(x −µ)⊤
Σ−1)
=1
2 log((2π)d|Σ|) + 1
2 tr(Eq(x)

(x −µq)(x −µq)⊤+ (µq −µ)(µq −µ)⊤
Σ−1)
=1
2 log((2π)d|Σ|) + 1
2 tr(

Σq + (µq −µ)(µq −µ)⊤
Σ−1)
=1
2 log((2π)d|Σ|) + 1
2 tr(ΣqΣ−1) + 1
2 tr((µq −µ)(µq −µ)⊤Σ−1)
=1
2 log((2π)d|Σ|) + 1
2 tr(ΣqΣ−1) + 1
2(µq −µ)⊤Σ−1(µq −µ)
=H(N(x|µq, Σq), p).
Lemma 2. (KL to Gaussian) Suppose q(x) is a probability density function with mean µq and
covariance matrix Σq and p(x) = N(x|µ, Σ) is a Gaussian distribution, then
DKL(q||p) = DKL(N(x|µq, Σq)||p) + H(N(x|µq, Σq)) −H(q),
where H(·) denotes the entropy of a distribution.
Proof. According to Lemma 1, we have H(q, p) = H(N(x|µq, Σq), p). Thereby,
DKL(q||p) = H(q, p) −H(q) = H(N(x|µq, Σq), p) −H(q)
=H(N(x|µq, Σq), p) −H(N(x|µq, Σq)) + H(N(x|µq, Σq)) −H(q)
=DKL(N(x|µq, Σq)||p) + H(N(x|µq, Σq)) −H(q).
Lemma 3. (Equivalence between the forward and reverse Markov property) Suppose q(x0:N) =
q(x0)
NQ
n=1
q(xn|xn−1) is a Markov chain, then q is also a Markov chain in the reverse direction,
i.e., q(x0:N) = q(xN)
NQ
n=1
q(xn−1|xn).
13

Published as a conference paper at ICLR 2022
Proof.
q(xn−1|xn, · · · , xN) = q(xn−1, xn, · · · , xN)
q(xn, · · · , xN)
=
q(xn−1, xn)
NQ
i=n+1
q(xi|xi−1)
q(xn)
NQ
i=n+1
q(xi|xi−1)
= q(xn−1|xn).
Thereby, q(x0:N) = q(xN)
NQ
n=1
q(xn−1|xn).
Lemma 4. (Entropy of a Markov chain) Suppose q(x0:N) is a Markov chain, then
H(q(x0:N)) = H(q(xN)) +
N
X
n=1
EqH(q(xn−1|xn)) = H(q(x0)) +
N
X
n=1
EqH(q(xn|xn−1)).
Proof. According to Lemma 3, we have
H(q(x0:N)) = −Eq log q(xN)
N
Y
n=1
q(xn−1|xn) = −Eq log q(xN) −
N
X
n=1
Eq log q(xn−1|xn)
=H(q(xN)) +
N
X
n=1
EqH(q(xn−1|xn)).
Similarly, we also have H(q(x0:N)) = H(q(x0)) +
N
P
n=1
EqH(q(xn|xn−1)).
Lemma 5. (Entropy of a DDPM forward process) Suppose q(x0:N) is a Markov chain and
q(xn|xn−1) = N(xn|√αnxn−1, βnI), then
H(q(x0:N)) = H(q(x0)) + d
2
N
X
n=1
log(2πeβn).
Proof. According to Lemma 4, we have
H(q(x0:N)) = H(q(x0)) +
N
X
n=1
EqH(q(xn|xn−1)) = H(q(x0)) +
N
X
n=1
d
2 log(2πeβn).
Lemma 6. (Entropy of a conditional Markov chain) Suppose q(x1:N|x0) is Markov, then
H(q(x0:N)) = H(q(x0)) + EqH(q(xN|x0)) +
N
X
n=2
EqH(q(xn−1|xn, x0)).
Proof. According to Lemma 4, we have
H(q(x0:N)) =H(q(x0)) + EqH(q(x1:N|x0))
=H(q(x0)) + EqH(q(xN|x0)) +
N
X
n=2
EqH(q(xn−1|xn, x0)).
14

Published as a conference paper at ICLR 2022
Lemma 7. (Entropy of a generalized DDPM forward process) Suppose q(x1:N|x0) is Markov,
q(xN|x0) is Gaussian with covariance βNI and q(xn−1|xn, x0) is Gaussian with covariance λ2
nI,
then
H(q(x0:N)) = H(q(x0)) + d
2 log(2πeβN) + d
2
N
X
n=2
log(2πeλ2
n).
Proof. Directly derived from Lemma 6.
Lemma 8. (KL to a Markov chain) Suppose q(x0:N) is a probability distribution and p(x0:N) =
p(xN)
NQ
n=1
p(xn−1|xn) is a Markov chain, then we have
EqDKL(q(x0:N−1|xN)||p(x0:N−1|xN)) =
N
X
n=1
EqDKL(q(xn−1|xn)||p(xn−1|xn)) + c,
where c =
N
P
n=1
EqH(q(xn−1|xn)) −EqH(q(x0:N−1|xN)) is only related to q. Particularly, if
q(x0:N) is also a Markov chain, then c = 0.
Proof.
EqDKL(q(x0:N−1|xN)||p(x0:N−1|xN)) = −Eq log p(x0:N−1|xN) −EqH(q(x0:N−1|xN))
= −
N
X
n=1
Eq log p(xn−1|xn) −EqH(q(x0:N−1|xN))
=
N
X
n=1
EqDKL(q(xn−1|xn)||p(xn−1|xn)) +
N
X
n=1
EqH(q(xn−1|xn)) −EqH(q(x0:N−1|xN)).
Let c =
N
P
n=1
EqH(q(xn−1|xn)) −EqH(q(x0:N−1|xN)), then
EqDKL(q(x0:N−1|xN)||p(x0:N−1|xN)) =
N
X
n=1
EqDKL(q(xn−1|xn)||p(xn−1|xn)) + c.
If q(x0:N) is also a Markov chain, according to Lemma 4, we have c = 0.
Lemma 9. (The optimal Markov reverse process with Gaussian transitions is equivalent to moment
matching) Suppose q(x0:N) is probability density function and p(x0:N) =
NQ
n=1
p(xn−1|xn)p(xN)
is a Gaussian Markov chain with p(xn−1|xn) = N(xn−1|µn(xn), σ2
nI), then the joint KL opti-
mization
min
{µn,σ2
n}N
n=1
DKL(q(x0:N)||p(x0:N))
has an optimal solution
µ∗
n(xn) = Eq(xn−1|xn)[xn−1],
σ∗2
n = Eqn(xn)
tr(Covq(xn−1|xn)[xn−1])
d
,
which match the ﬁrst two moments of q(xn−1|xn). The corresponding optimal KL is
DKL(q(x0:N)||p∗(x0:N)) = H(q(xN), p(xN)) + d
2
N
X
n=1
log(2πeσ∗2
n ) −H(q(x0:N)).
Remark. Lemma 9 doesn’t assume the form of q(x0:N), thereby it can be applied to more general
Gaussian models, such as multi-layer VAEs with Gaussian decoders (Rezende et al., 2014; Burda
et al., 2015). In this case, q(x1:N|x0) is the hierarchical encoders of multi-layer VAEs.
15

Published as a conference paper at ICLR 2022
Proof. According to Lemma 8, we have
DKL(q(x0:N)||p(x0:N)) = DKL(q(xN)||p(xN)) +
N
X
n=1
EqDKL(q(xn−1|xn)||p(xn−1|xn)) + c,
where c =
N
P
n=1
EqH(q(xn−1|xn)) −EqH(q(x0:N−1|xN)).
Since EqDKL(q(xn−1|xn)||p(xn−1|xn)) is only related to µn(·) and σ2
n, the joint KL optimization
is decomposed into n independent optimization sub-problems:
min
µn,σ2n
EqDKL(q(xn−1|xn)||p(xn−1|xn)),
1 ≤n ≤N.
According to Lemma 2, we have
EqDKL(q(xn−1|xn)||p(xn−1|xn))
=EqDKL(N(xn−1|Eq(xn−1|xn)[xn−1], Covq(xn−1|xn)[xn−1])||p(xn−1|xn))
+ EqH(N(xn−1|Eq(xn−1|xn)[xn−1], Covq(xn−1|xn)[xn−1])) −EqH(q(xn−1|xn))
=F(σ2
n) + G(σ2
n, µn) + c′
where
F(σ2
n) = 1
2
 σ−2
n Eq tr(Covq(xn−1|xn)[xn−1]) + d log σ2
n

,
G(σ2
n, µn) = 1
2σ−2
n Eq||Eq(xn−1|xn)[xn−1] −µn(xn)||2,
and c′ = d
2 log(2π) −EqH(q(xn−1|xn)). The optimal µ∗
n(xn) is achieved when
||Eq(xn−1|xn)[xn−1] −µn(xn)||2 = 0.
Thereby, µ∗
n(xn) = Eq(xn−1|xn)[xn−1]. In this case, G(σ2
n, µ∗
n) = 0 and we only need to consider
F(σ2
n) for the optimal σ∗2
n . By calculating the gradient of F, we know that F gets its minimum at
σ∗2
n = Eq
tr(Covq(xn−1|xn)[xn−1])
d
.
In the optimal case, F(σ∗2
n ) = d
2(1 + log σ∗2
n ) and
EqDKL(q(xn−1|xn)||p∗(xn−1|xn)) = d
2 log(2πeσ∗2
n ) −EqH(q(xn−1|xn)).
As a result,
DKL(q(x0:N)||p∗(x0:N))
=DKL(q(xN)||p(xN)) +
N
X
n=1
d
2 log(2πeσ∗2
n ) −
N
X
n=1
EqH(q(xn−1|xn))
+
N
X
n=1
EqH(q(xn−1|xn)) −(H(q(x0:N)) −H(q(xN)))
=H(q(xN), p(xN)) +
N
X
n=1
d
2 log(2πeσ∗2
n ) −H(q(x0:N)).
Lemma 10. (Marginal score function) Suppose q(v, w) is a probability distribution, then
∇w log q(w) =Eq(v|w)∇w log q(w|v)
16

Published as a conference paper at ICLR 2022
Proof. According to Eq(v|w)∇w log q(v|w) =
R
∇wq(v|w)dv = ∇w
R
q(v|w)dv = 0, we have
∇w log q(w) =∇w log q(w) + Eq(v|w)∇w log q(v|w)
=Eq(v|w)∇w log q(v, w) = Eq(v|w)∇w log q(w|v).
Lemma 11. (Score representation of conditional expectation and covariance) Suppose q(v, w) =
q(v)q(w|v), where q(w|v) = N(w|√αv, βI), then
Eq(v|w)[v] =
1
√α(w + β∇w log q(w)),
Eq(w)Covq(v|w)[v] = β
α
 I −βEq(w)

∇w log q(w)∇w log q(w)⊤
,
Eq(w)
tr(Covq(v|w)[v])
d
= β
α

1 −βEq(w)
||∇w log q(w)||2
d

.
Proof. According to Lemma 10, we have
∇w log q(w) = Eq(v|w)∇w log q(w|v) = −Eq(v|w)
w −√αv
β
.
Thereby, Eq(v|w)[v] =
1
√α(w + β∇w log q(w)). Furthermore, we have
Eq(w)Covq(v|w)[v] = β2
α Eq(w)Covq(v|w)[w −√αv
β
]
=β2
α Eq(w)

Eq(v|w)(w −√αv
β
)(w −√αv
β
)⊤−Eq(v|w)[w −√αv
β
]Eq(v|w)[w −√αv
β
]⊤

=β2
α
 1
β2 Eq(v)Eq(w|v)(w −√αv)(w −√αv)⊤−Eq(w)∇w log q(w)∇w log q(w)⊤

=β2
α
 1
β2 Eq(v)Covq(w|v)w −Eq(w)∇w log q(w)∇w log q(w)⊤

=β2
α
 1
β2 Eq(v)βI −Eq(w)∇w log q(w)∇w log q(w)⊤

=β2
α
 1
β I −Eq(w)∇w log q(w)∇w log q(w)⊤

= β
α(I −βEq(w)∇w log q(w)∇w log q(w)⊤).
Taking the trace, we have
Eq(w)
tr(Covq(v|w)[v])
d
= β
α(1 −βEq(w)
||∇w log q(w)||2
d
).
Lemma 12. (Bounded covariance of a bounded distribution) Suppose q(x) is a bounded distribution
in [a, b]d, then
tr(Covq(x)[x])
d
≤( b−a
2 )2.
Proof.
tr(Covq(x)[x])
d
= tr(Covq(x)[x −a+b
2 ])
d
= Eq(x)||x −a+b
2 ||2 −||Ex −a+b
2 ||2
d
≤Eq(x)||x −a+b
2 ||2
d
≤(b −a
2
)2.
17

Published as a conference paper at ICLR 2022
Lemma 13. (Convert the moments of q(xn−1|xn) to moments of q(x0|xn)) The optimal solution
µ∗
n(xn) and σ∗2
n to Eq. (4) can be represented by the ﬁrst two moments of q(x0|xn)
µ∗
n(xn) = ˜µn(xn, Eq(x0|xn)x0)
σ∗2
n = λ2
n +
 
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
!2
Eq(xn)
tr(Covq(x0|xn)[x0])
d
where qn(xn) is the marginal distribution of the forward process at timestep n and d is the dimension
of the data.
Proof. According to Lemma 9, the optimal µ∗
n and σ∗2
n under KL minimization is
µ∗
n(xn) = Eq(xn−1|xn)[xn−1],
σ∗2
n = Eqn(xn)
tr(Covq(xn−1|xn)[xn−1])
d
.
We further derive µ∗
n. Since ˜µn(xn, x0) is linear w.r.t. x0, we have
µ∗
n(xn) = Eq(xn−1|xn)[xn−1] = Eq(x0|xn)Eq(xn−1|xn,x0)[xn−1]
=Eq(x0|xn) ˜µn(xn, x0) = ˜µn(xn, Eq(x0|xn)x0).
Then we consider σ∗2
n . According to the law of total variance, we have
Covq(xn−1|xn)[xn−1] = Eq(x0|xn)Covq(xn−1|xn,x0)[xn−1] + Covq(x0|xn)Eq(xn−1|xn,x0)[xn−1]
=λ2
nI + Covq(x0|xn) ˜µn(xn, x0) = λ2
nI + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2Covq(x0|xn)[x0].
Thereby,
σ∗2
n = Eqn(xn)
tr(Covq(xn−1|xn)[xn−1])
d
=λ2
n + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2Eq(xn)
tr(Covq(x0|xn)[x0])
d
.
A.2
PROOF OF THEOREM 1
Theorem 1. (Score representation of the optimal solution to Eq. (4), proof in Appendix A.2)
The optimal solution µ∗
n(xn) and σ∗2
n to Eq. (4) are
µ∗
n(xn) = ˜µn

xn,
1
√αn
(xn + βn∇xn log qn(xn))

,
(6)
σ∗2
n = λ2
n +


s
βn
αn
−
q
βn−1 −λ2n


2 
1 −βnEqn(xn)
||∇xn log qn(xn)||2
d

,
(7)
where qn(xn) is the marginal distribution of the forward process at the timestep n and d is the
dimension of the data.
Proof. According to Lemma 11 and Lemma 13, we have
µ∗
n(xn) = ˜µn(xn, Eq(x0|xn)x0) = ˜µn(xn,
1
√αn
(xn + βn∇xn log q(xn))),
18

Published as a conference paper at ICLR 2022
and
σ∗2
n = λ2
n + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2Eq(xn)
tr(Covq(x0|xn)[x0])
d
=λ2
n + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2 βn
αn
(1 −βnEq(xn)
||∇xn log q(xn)||2
d
)
=λ2
n + (
s
βn
αn
−
q
βn−1 −λ2n)2(1 −βnEq(xn)
||∇xn log q(xn)||2
d
).
A.3
PROOF OF THEOREM 2
Theorem 2. (Bounds of the optimal reverse variance, proof in Appendix A.3)
σ∗2
n has the following lower and upper bounds:
λ2
n ≤σ∗2
n ≤λ2
n +


s
βn
αn
−
q
βn−1 −λ2n


2
.
(11)
If we further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σ∗2
n can be further upper bounded by
σ∗2
n ≤λ2
n +
 
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
!2 b −a
2
2
.
(12)
Proof. According to Lemma 13 and Theorem 1, we have
λ2
n ≤σ∗2
n ≤λ2
n + (
s
βn
αn
−
q
βn−1 −λ2n)2.
If we further q(x0) assume is a bounded distribution in [a, b]d, then q(x0|xn) is also a bounded
distribution in [a, b]d. According to Lemma 12, we have
Eq(xn)
tr(Covq(x0|xn)[x0])
d
≤(b −a
2
)2.
Combining with Lemma 13, we have
σ∗2
n =λ2
n + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2Eq(xn)
tr(Covq(x0|xn)[x0])
d
≤λ2
n + (
p
αn−1 −
q
βn−1 −λ2n ·
s
αn
βn
)2(b −a
2
)2.
A.4
PROOF OF THE DECOMPOSED OPTIMAL KL
Theorem 3. (Decomposed optimal KL, proof in Appendix A.4)
The KL divergence between the shorter forward process and its optimal reverse process is
DKL(q(x0, xτ1, · · · , xτK)||p∗(x0, xτ1, · · · , xτK)) = d
2
K
X
k=2
J(τk−1, τk) + c,
where J(τk−1, τk) = log
σ∗2
τk−1|τk
λ2
τk−1|τk
and c is a constant unrelated to the trajectory τ.
19

Published as a conference paper at ICLR 2022
Proof. According to Lemma 7 and Lemma 9, we have
DKL(q(x0, xτ1, · · · , xτK)||p∗(x0, xτ1, · · · , xτK))
=EqDKL(q(x0|xτ1, · · · , xτK)||p∗(x0|x1)) + DKL(q(xτ1, · · · , xτK)||p∗(xτ1, · · · , xτK))
=EqDKL(q(x0|xτ1, · · · , xτK)||p∗(x0|x1)) + H(q(xN), p(xN))
+ d
2
K
X
k=2
log(2πeσ∗2
τk−1|τk) −H(q(xτ1, · · · , xτN ))
= −Eq log p∗(x0|x1) + H(q(xN), p(xN)) + d
2
K
X
k=2
log(2πeσ∗2
τk−1|τk) −H(q(x0, xτ1, · · · , xτK))
= −Eq log p∗(x0|x1) + H(q(xN), p(xN)) + d
2
K
X
k=2
log(2πeσ∗2
τk−1|τk)
−H(q(x0)) −d
2 log(2πeβN) −d
2
K
X
k=2
log(2πeλ2
τk−1|τk)
= −Eq log p∗(x0|x1) + H(q(xN), p(xN)) + d
2
K
X
k=2
log
σ∗2
τk−1|τk
λ2
τk−1|τk
−H(q(x0)) −d
2 log(2πeβN).
Let J(τk−1, τk) = log
σ∗2
τk−1|τk
λ2
τk−1|τk
and c = −Eq log p∗(x0|x1) + H(q(xN), p(xN)) −H(q(x0)) −
d
2 log(2πeβN), then c is a constant unrelated to the trajectory τ and
DKL(q(x0, xτ1, · · · , xτK)||p∗(x0, xτ1, · · · , xτK)) = d
2
K
X
k=2
J(τk−1, τk) + c.
A.5
THE FORMAL RESULT FOR SECTION 5 AND ITS PROOF
Here we present the formal result of the relationship between the score function and the data covari-
ance matrix mentioned in Section 5.
Proposition 1. (Proof in Appendix A.5) The expected conditional covariance matrix of the data
distribution is determined by the score function ∇xn log qn(xn) as follows:
Eq(xn)Covq(x0|xn)[x0] = βn
αn
 I −βnEqn(xn)

∇xn log qn(xn)∇xn log qn(xn)⊤
,
(15)
which contributes to the data covariance matrix according to the law of total variance
Covq(x0)[x0] = Eq(xn)Covq(x0|xn)[x0] + Covq(xn)Eq(x0|xn)[x0].
(16)
Proof. Since q(xn|x0) = N(xn|√αnx0, βnI), according to Lemma 11, we have
Eq(xn)Covq(x0|xn)[x0] = βn
αn
(I −βnEqn(xn)∇xn log qn(xn)∇xn log qn(xn)⊤).
The law of total variance is a classical result in statistics. Here we prove it for completeness:
Eq(xn)Covq(x0|xn)[x0] + Covq(xn)Eq(x0|xn)[x0]
=Eq(xn)
 Eq(x0|xn)x0x⊤
0 −Eq(x0|xn)[x0]Eq(x0|xn)[x0]⊤
+ Eq(xn)
 Eq(x0|xn)[x0]Eq(x0|xn)[x0]⊤
−
 Eq(xn)Eq(x0|xn)[x0]
  Eq(xn)Eq(x0|xn)[x0]
⊤
=Eq(x0)x0x⊤
0 −Eq(x0)[x0]Eq(x0)[x0]⊤= Covq(x0)[x0].
20

Published as a conference paper at ICLR 2022
Algorithm 1 The DP algorithm for the least-cost-path problem (Watson et al., 2021)
1: Input: Cost function J(s, t) and integers K, N (1 ≤K ≤N)
2: Output: The least-cost-trajectory 1 = τ1 < · · · < τK = N
3: C ←{∞}1≤k,n≤N, D ←{−1}1≤k,n≤N
4: C[1, 1] ←0
5: for k = 2 to K do
▷Calculate C and D
6:
CJ ←{C[k −1, s] + J(s, n)}1≤s≤N,k≤n≤N
7:
C[k, k :] ←(min(CJ[:, k]), min(CJ[:, k + 1]), · · · , min(CJ[:, N]))
8:
D[k, k :] ←(arg min(CJ[:, k]), arg min(CJ[:, k + 1]), · · · , arg min(CJ[:, N]))
9: end for
10: τK = N
11: for k = K to 2 do
▷Calculate τ
12:
τk−1 ←D[k, τk]
13: end for
14: return τ
B
THE DP ALGORITHM FOR THE LEAST-COST-PATH PROBLEM
Given a cost function J(s, t) with 1 ≤s < t and k, n ≥1, we want to ﬁnd a trajectory 1 =
τ1 < · · · < τk = n of k nodes starting from 1 and terminating at n, s.t., the total cost J(τ1, τ2) +
J(τ2, τ3) + · · · + J(τk−1, τk) is minimized. Such a problem can be solved by the DP algorithm
proposed by Watson et al. (2021). Let C[k, n] be the minimized cost of the optimal trajectory, and
D[k, n] be the τk−1 of the optimal trajectory. For simplicity, we also let J(s, t) = ∞for s ≥t ≥1.
Then for k = 1, we have C[1, n] =

0
n = 1
∞
N ≥n > 1
and D[1, n] = −1 (here ∞and −1
represent undeﬁned values for simplicity). For N ≥k ≥2, we have
C[k, n] =
(
∞
1 ≤n < k
min
k−1≤s≤n−1 C[k −1, s] + J(s, n) =
min
1≤s≤N C[k −1, s] + J(s, n)
N ≥n ≥k,
D[k, n] =
( −1
1 ≤n < k
arg min
k−1≤s≤n−1
C[k −1, s] + J(s, n) = arg min
1≤s≤N
C[k −1, s] + J(s, n)
N ≥n ≥k.
As long as D is calculated, we can get the optimal trajectory recursively by τK = N and τk−1 =
D[k, τk]. We summarize the algorithm in Algorithm 1.
C
THE BOUNDS OF THE OPTIMAL REVERSE VARIANCE CONSTRAINED ON A
TRAJECTORY
In Section 4, we derive the optimal reverse variance constrained on a trajectory. Indeed, the optimal
reverse variance can also be bounded similar to Theorem 2. We formalize it in Corollary 1.
Corollary 1. (Bounds of the optimal reverse variance constrained on a trajectory)
σ∗2
τk−1|τk has the following lower and upper bounds:
λ2
τk−1|τk ≤σ∗2
τk−1|τk ≤λ2
τk−1|τk +


s
βτk
ατk|τk−1
−
q
βτk−1 −λ2
τk−1|τk


2
.
If we further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σ∗2
n can be further upper bounded by
σ∗2
τk−1|τk ≤λ2
τk−1|τk +
 
pατk−1 −
q
βτk−1 −λ2
τk−1|τk ·
s
ατk
βτk
!2
(b −a
2
)2.
21

Published as a conference paper at ICLR 2022
D
SIMPLIFIED RESULTS FOR THE DDPM FORWARD PROCESS
The optimal solution µ∗
n(xn) and σ∗2
n in Theorem 1 and the bounds of σ∗2
n in Theorem 2 can be
directly simpliﬁed for the DDPM forward process by letting λ2
n = ˜βn. We list the simpliﬁed results
in Corollary 2 and Corollary 3.
Corollary 2. (Simpliﬁed score representation of the optimal solution)
When λ2
n = ˜βn, the optimal solution µ∗
n(xn) and σ∗2
n to Eq. (4) are
µ∗
n(xn) =
1
√αn
(xn + βn∇xn log qn(xn)),
σ∗2
n = βn
αn
(1 −βnEqn(xn)
||∇xn log qn(xn)||2
d
).
Corollary 3. (Simpliﬁed bounds of the optimal reverse variance)
When λ2
n = ˜βn, σ∗2
n has the following lower and upper bounds:
˜βn ≤σ∗2
n ≤βn
αn
.
If we further assume q(x0) is a bounded distribution in [a, b]d, where d is the dimension of data,
then σ∗2
n can be further upper bounded by
σ∗2
n ≤˜βn + αn−1β2
n
β
2
n
b −a
2
2
.
As for the shorter forward process deﬁned in Eq. (13), it also includes the DDPM as a special case
when λ2
τk−1|τk = ˜βτk−1|τk, where ˜βτk−1|τk :=
βτk−1
βτk
βτk|τk−1. Similar to Corollary 2, the optimal
mean and variance of its reverse process can also be simpliﬁed for DDPMs by letting λ2
τk−1|τk =
˜βτk−1|τk. Formally, the simpliﬁed optimal mean and variance are
µ∗
τk−1|τk(xτk) =
1
√ατk|τk−1
(xτk + βτk|τk−1∇xτk log qτk(xτk)),
σ∗2
τk−1|τk = βτk|τk−1
ατk|τk−1
(1 −βτk|τk−1Eqτk (xτk )
||∇xτk log qτk(xτk)||2
d
).
Besides, Theorem 3 can also be simpliﬁed for DDPMs. We list the simpliﬁed result in Corollary 4.
Corollary 4. (Simpliﬁed decomposed optimal KL)
When λ2
n = ˜βn, the KL divergence between the subprocess and its optimal reverse process is
DKL(q(x0, xτ1, · · · , xτK)||p∗(x0, xτ1, · · · , xτK)) = d
2
K
X
k=2
J(τk−1, τk) + c,
where J(τk−1, τk) = log(1 −βτk|τk−1Eqτk (xτk )
||∇xτk log qτk(xτk)||2
d
),
and c is a constant unrelated to the trajectory τ.
E
EXTENSION TO DIFFUSION PROCESS WITH CONTINUOUS TIMESTEPS
Song et al. (2020b) generalizes the diffusion process to continuous timesteps by introducing a
stochastic differential equation (SDE) dz = f(t)zdt + g(t)dw. Without loss of generality, we
consider the parameterization of f(t) and g(t) introduced by Kingma et al. (2021)
f(t) = 1
2
d log αt
dt
,
g(t)2 = dβt
dt −d log αt
dt
βt,
22

Published as a conference paper at ICLR 2022
where αt and βt are scalar-valued functions satisfying some regular conditions (Kingma et al., 2021)
with domain t ∈[0, 1]. Such a parameterization induces a diffusion process on continuous timesteps
q(x0, z[0,1]), s.t.,
q(zt|x0) = N(zt|√αtx0, βtI),
∀t ∈[0, 1],
q(zt|zs) = N(zt|√αt|szs, βt|sI),
∀0 ≤s < t ≤1,
where αt|s := αt/αs and βt|s := βt −αt|sβs.
E.1
ANALYTIC ESTIMATE OF THE OPTIMAL REVERSE VARIANCE
Kingma et al. (2021) introduce p(zs|zt) = N(zs|µs|t(zt), σ2
s|t) (s < t) to reverse from timestep
t to timestep s, where σ2
s|t is ﬁxed to βs
βt βs|t. In contrast, we show that σ2
s|t also has an optimal
solution in an analytic form of the score function under the sense of KL minimization. According to
Lemma 9 and Lemma 11, we have
µ∗
s|t(zt) = Eq(zs|zt)[zs] =
1
√αt|s
(zt + βt|s∇zt log q(zt)),
σ∗2
s|t = Eq
tr(Covq(zs|zt)[zs])
d
= βt|s
αt|s
(1 −βt|sEq(zt)
||∇zt log q(zt)||2
d
).
Thereby, both the optimal mean and variance have a closed form expression w.r.t. the score function.
In this case, we ﬁrst estimate the expected mean squared norm of the score function by Γt for
t ∈[0, 1], where
Γt = Eq(zt)
||st(zt)||2
d
.
Notice that there are inﬁnite timesteps in [0, 1]. In practice, we can only choose a ﬁnite number of
timesteps 0 = t1 < · · · < tN = 1 and calculate Γtn. For a timestep t between tn−1 and tn, we can
use a linear interpolation between Γtn−1 and Γtn. Then, we can estimate σ∗2
s|t by
ˆσ2
s|t = βt|s
αt|s
(1 −βt|sΓt).
E.2
ANALYTIC ESTIMATION OF THE OPTIMAL REVERSE TRAJECTORY
Now we consider optimize the trajectory 0 = τ1 < · · · < τK = 1 in the sense of KL minimization
min
τ1,··· ,τK DKL(q(x0, zτ1, · · · , zτK)||p∗(x0, zτ1, · · · , zτK)).
Similar to Theorem 3, the optimal KL is
DKL(q(x0, zτ1, · · · , zτK)||p∗(x0, zτ1, · · · , zτK)) = d
2
K
X
k=2
J(τk−1, τk) + c,
where J(τk−1, τk) = log(1 −βτk|τk−1Eq
||∇zτk log q(zτk )||2
d
) and c is unrelated to τ. The difference
is that J(s, t) is deﬁned on a continuous range 0 ≤s < t ≤1 and the DP algorithm is not directly
applicable. However, we can restrict J(s, t) on a ﬁnite number of timesteps 0 = t1 < · · · < tN = 1.
Then we can apply the DP algorithm (see Algorithm 1) to the restricted J(s, t).
23

Published as a conference paper at ICLR 2022
F
EXPERIMENTAL DETAILS
F.1
DETAILS OF SCORE-BASED MODELS
The CelebA 64x64 pretrained score-based model is provided in the ofﬁcial code (https://
github.com/ermongroup/ddim) of Song et al. (2020a). The LSUN Bedroom pretrained
score-based model is provided in the ofﬁcial code (https://github.com/hojonathanho/
diffusion) of Ho et al. (2020). Both of them have a total of N = 1000 timesteps and use the
linear schedule (Ho et al., 2020) as the forward noise schedule.
The ImageNet 64x64 pretrained score-based model is the unconditional Lhybrid model provided
in the ofﬁcial code (https://github.com/openai/improved-diffusion) of Nichol
& Dhariwal (2021). The model includes both the mean and variance networks, where the mean
network is trained with Eq. (5) as the standard DDPM (Ho et al., 2020) and the variance network is
trained with the Lvb objective. We only use the mean network. The model has a total of N = 4000
timesteps and its forward noise schedule is the cosine schedule (Nichol & Dhariwal, 2021).
The CIFAR10 score-based models are trained by ourselves.
They have a total of N = 1000
timesteps and are trained with the linear forward noise schedule and the cosine forward noise sched-
ule respectively. We use the same U-Net model architecture to Nichol & Dhariwal (2021). Follow-
ing Nichol & Dhariwal (2021), we train 500K iterations with a batch size of 128, use a learning rate
of 0.0001 with the AdamW optimizer (Loshchilov & Hutter, 2017) and use an exponential mov-
ing average (EMA) with a rate of 0.9999. We save a checkpoint every 10K iterations and select
the checkpoint according to the FID results on 1000 samples generated under the reverse variance
σ2
n = βn and full timesteps.
F.2
LOG-LIKELIHOOD AND SAMPLING
Following Ho et al. (2020), we linearly scale the image data consisting of integers in {0, 1, · · · , 255}
to [−1, 1], and discretize the last reverse Markov transition p(x0|x1) to obtain discrete log-
likelihoods for image data.
Following Ho et al. (2020), at the end of sampling, we only display the mean of p(x0|x1) and discard
the noise. This is equivalent to setting a clipping threshold of zero for the noise scale σ1. Inspired
by this, when sampling, we also clip the noise scale σ2 of p(x1|x2), such that E|σ2ϵ| ≤
2
255y,
where ϵ is the standard Gaussian noise and y is the maximum tolerated perturbation of a channel. It
improves the sample quality, especially for our analytic estimate (see Appendix G.4). We clip σ2 for
all methods compared in Table 2, and choose y ∈{1, 2} according to the FID score. We ﬁnd y = 2
works better on CIFAR10 (LS) and CelebA 64x64 with Analytic-DDPM. For other cases, we ﬁnd
y = 1 works better.
We use the ofﬁcial implementation of FID to pytorch (https://github.com/mseitzer/
pytorch-fid). We calculate the FID score on 50K generated samples on all datasets. Follow-
ing Nichol & Dhariwal (2021), the reference distribution statistics are computed on the full training
set for CIFAR10 and ImageNet 64x64. For CelebA 64x64 and LSUN Bedroom, the reference dis-
tribution statistics is computed on 50K training samples.
F.3
CHOICE OF THE NUMBER OF MONTE CARLO SAMPLES AND CALCULATION OF Γ
We use a maximal M without introducing too much computation. Speciﬁcally, we set M = 50000
on CIFAR10, M = 10000 on CelebA 64x64 and ImageNet 64x64 and M = 1000 on LSUN
Bedroom by default without a sweep. All of the samples are from the training dataset. We use the
default settings of M for all results in Table 1, Table 2 and Table 3.
We only calculate Γ in Eq. (8) once for a pretrained model, and Γ is reused during inference under
different settings (e.g., trajectories of smaller K) in Table 1, Table 2 and Table 3.
24

Published as a conference paper at ICLR 2022
F.4
IMPLEMENTATION OF THE EVEN TRAJECTORY
We follow Nichol & Dhariwal (2021) for the implementation of the even trajectory. Given the
number of timesteps K of a trajectory, we ﬁrstly determine the stride a =
N−1
K−1. Then the kth
timestep is determined as round(1 + a(k −1)).
F.5
EXPERIMENTAL DETAILS OF TABLE 3
In Table 3, the results of DDPM, DDIM and Analytic-DPM are based on the same score-
based models (i.e., those listed in Section F.1). We get the results of Improved DDPM by run-
ning its ofﬁcial code and unconditional Lhybrid models (https://github.com/openai/
improved-diffusion). As shown in Table 4, on the same dataset, the sizes as well as the
averaged time of a single function evaluation of these models are almost the same.
Table 4: Model size and the averaged time to run a model function evaluation with a batch size of
10 on one GeForce RTX 2080 Ti.
CIFAR10
CelebA 64x64
LSUN Bedroom
DDPM, DDIM, Analytic-DPM
200.44 MB / 29 ms
300.22 MB / 50 ms
433.63 MB / 438 ms
Improved DDPM
200.45 MB / 30 ms
Missing model
433.64 MB / 439 ms
The DDPM and DDIM results on CIFAR10 are based on the quadratic trajectory following Song
et al. (2020a), which gets better FID than the even trajectory. The Analytic-DPM result is based on
the DDPM forward process on LSUN Bedroom, and based on the DDIM forward process on other
datasets. These choices achieve better efﬁciency than their alternatives.
25

Published as a conference paper at ICLR 2022
G
ADDITIONAL RESULTS
G.1
VISUALIZATION OF REVERSE VARIANCES AND VARIATIONAL BOUND TERMS
Figure 1 visualizes the reverse variances and Lvb terms on CIFAR10 with the linear forward noise
schedule (LS). In Figure 2, we show more DDPM results on CIFAR10 with the cosine forward noise
schedule (CS), CelebA 64x64 and ImageNet 64x64.
22
25
28
timestep n
2
14
2
8
2
2
variance
23
2
14
n
n
2
n
(a) CIFAR10 (CS)
22
25
28
timestep n
2
13
2
11
2
9
2
7
variance
23
2
13
2
12
n
n
2
n
(b) CelebA 64x64
23
27
211
timestep n
2
15
2
11
2
7
2
3
variance
23
2
16
n
n
2
n
(c) ImageNet 64x64
22
25
28
timestep n
0.1
0.2
0.3
0.4
Lvb term 
 (bits/dim)
22
0.1
n
n
2
n
(d) CIFAR10 (CS)
22
25
28
timestep n
0.1
0.2
0.3
Lvb term 
 (bits/dim)
22
0.1
n
n
2
n
(e) CelebA 64x64
22
25
28
211
timestep n
0.2
0.4
0.6
Lvb term 
 (bits/dim)
20
21
0.4
n
n
2
n
(f) ImageNet 64x64
Figure 2: Comparing our analytic estimate ˆσ2
n and prior works with handcrafted variances βn and
˜βn. (a-c) compare the values of the variance of different timesteps. (d-e) compare the term in Lvb
corresponding to each timestep. The value of Lvb is the area under the corresponding curve.
G.2
ABLATION STUDY ON THE NUMBER OF MONTE CARLO SAMPLES
We show that only a small number of Monte Carlo (MC) samples M in Eq. (8) is enough for a small
MC variance. As shown in Figure 3, the values of Γn with M = 100 and M = 50000 Monte Carlo
samples are almost the same in a single trial. To explicitly see the variance, in Figure 4 and Figure 5,
we plot the mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio of
the standard deviation to the mean) of a single Monte Carlo sample ||sn(xn)||2
d
, xn ∼qn(xn) and
Γn with different M respectively on CIFAR10 (LS). In all cases, the RSD decays fast as n increases.
When n is small (e.g., n = 1), using M = 10 Monte Carlo samples can ensure that the RSD of Γn is
below 0.1, and using M = 100 Monte Carlo samples can ensure that the RSD of Γn is about 0.025.
When n > 100, the RSD of a single Monte Carlo sample is below 0.05, and using only M = 1
Monte Carlo sample can ensure the RSD of Γn is below 0.05. Overall, a small M like 10 and 100 is
sufﬁcient for a small Monte Carlo variance.
Furthermore, we show that Analytic-DPM with a small M like 10 and 100 has a similar performance
to that with a large M. As shown in Figure 6 (a), using M = 100 or M = 50000 almost does not
affect the likelihood results on CIFAR10 (LS). In Table 5 (a), we show results with even smaller M
(e.g., M = 1, 3, 10). Under both the NLL and FID metrics, M = 10 achieves a similar result to that
of M = 50000. The results are similar on ImageNet 64x64, as shown in Figure 6 (b) and Table 5
(b). Notably, the expected performance of FID is almost not inﬂuenced by the choice of M.
As a result, Analytic-DPM consistently improves the baselines using a much smaller M (e.g., M =
10), as shown in Table 6.
26

Published as a conference paper at ICLR 2022
100
101
102
103
timestep n
0
1000
2000
3000
4000
n
M=50000
M=100
(a) CIFAR10 (LS)
100
101
102
103
timestep n
0
5000
10000
15000
n
M=10000
M=100
(b) ImageNet 64x64
Figure 3: The value of Γn in a single trial with different number of Monte Carlo samples M.
100
101
102
103
timestep n
0
1000
2000
3000
4000
(a) Mean
100
101
102
103
timestep n
0
250
500
750
1000
1250
(b) Standard deviation
100
101
102
103
timestep n
0.05
0.10
0.15
0.20
0.25
(c) Relative standard deviation
Figure 4: The mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio
of the standard deviation to the mean) of a single Monte Carlo sample ||sn(xn)||2
d
, xn ∼qn(xn) at
different n on CIFAR10 (LS). These values are estimated by 50000 samples.
100
101
102
103
timestep n
0
1000
2000
3000
4000
(a) Mean
100
101
102
103
timestep n
0
250
500
750
1000
1250
M=1
M=10
M=100
(b) Standard deviation
100
101
102
103
timestep n
0.00
0.05
0.10
0.15
0.20
0.25
M=1
M=10
M=100
(c) Relative standard deviation
Figure 5: The mean, the standard deviation and the relative standard deviation (RSD) (i.e., the ratio
of the standard deviation to the mean) of Γn with different number of Monte Carlo samples M
at different n on CIFAR10 (LS). These values are directly calculated from the mean, the standard
deviation and the RSD of ||sn(xn)||2
d
, xn ∼qn(xn) presented in Figure 4.
27

Published as a conference paper at ICLR 2022
101
102
103
# timesteps K
3.5
4.0
4.5
5.0
5.5
nll 
 (bits/dim)
M=50000
M=100
(a) CIFAR10 (LS)
101
102
103
# timesteps K
4.0
4.5
5.0
nll 
 (bits/dim)
M=10000
M=100
(b) ImageNet 64x64
Figure 6: The curves of NLL v.s. the number of timesteps K in a trajectory with different number
of Monte Carlo samples M, evaluated under σ2
n = ˆσ2
n and the even trajectory.
Table 5: The negative log-likelihood (NLL) and the FID results of Analytic-DPM with different
number of Monte Carlo samples M. The results with M = 1, 3, 10, 100 are averaged by 5 runs. All
results are evaluated under the DDPM forward process and the even trajectory. We use K = 10 for
CIFAR10 (LS) and K = 25 for ImageNet 64x64.
(a) CIFAR10 (LS)
NLL ↓
FID ↓
M = 1
6.220±1.126
34.05±4.97
M = 3
5.689±0.424
34.29±2.88
M = 10
5.469±0.005
33.69±2.10
M = 100
5.468±0.004
34.63±0.68
M = 50000
5.471
34.26
(b) ImageNet 64x64
NLL ↓
FID ↓
M = 1
4.943±0.162
31.59±5.11
M = 3
4.821±0.055
31.98±1.19
M = 10
4.791±0.017
31.93±1.02
M = 100
4.785±0.003
31.93±0.69
M = 10000
4.783
32.56
Table 6: The NLL and FID comparison between Analytic-DDPM with M = 10 Monte Carlo
samples and DDPM. Results are evaluated under the even trajectory on CIFAR10 (LS).
# timesteps K
10
25
50
100
200
400
NLL ↓
Analytic-DDPM (M = 10)
5.47
4.80
4.38
4.07
3.85
3.71
DDPM
6.99
6.11
5.44
4.86
4.39
4.07
FID ↓
Analytic-DDPM (M = 10)
33.69
11.99
7.24
5.39
4.19
3.58
DDPM
44.45
21.83
15.21
10.94
8.23
4.86
G.3
TIGHTNESS OF THE BOUNDS
In Section 3.1 and Appendix C, we derive upper and lower bounds of the optimal reverse variance.
In this section, we show these bounds are tight numerically in practice. In Figure 7, we plot the
combined upper bound (i.e., the minimum of the upper bounds in Eq. (11) and Eq. (12)) and the
lower bound on CIFAR10. As shown in Figure 7 (a,c), the two bounds almost overlap under the full-
timesteps (K=N) trajectory. When the trajectory has a smaller number of timesteps (e.g., K=100),
the two bounds also overlap when the timestep τk is large. These results empirically validate that
our bounds are tight, especially when the timestep is large.
28

Published as a conference paper at ICLR 2022
22
25
28
timestep n
2
14
2
8
2
2
combined UB
LB
(a) LS, K=N
22
25
28
timestep 
k
2
14
2
8
2
2
combined UB
LB
(b) LS, K=100
22
25
28
timestep n
2
14
2
8
2
2
combined UB
LB
(c) CS, K=N
22
25
28
timestep 
k
2
14
2
8
2
2
combined UB
LB
(d) CS, K=100
Figure 7: The combined upper bound (UB) and the lower bound (LB) under full-timesteps (K=N)
and 100-timesteps (K=100) trajectories on CIFAR10 (LS) and CIFAR10 (CS).
In Figure 8, we also plot the two upper bounds in Eq. (11) and Eq. (12) individually. The upper
bound in Eq. (11) is tighter when the timestep is small and the other one is tighter when the timestep
is large. Thereby, both upper bounds contribute to the combined upper bound.
200
500
800
timestep n
2
10
2
6
2
2
UB in Eq.(11)
UB in Eq.(12)
(a) LS, K=N
200
500
800
timestep 
k
2
7
2
4
2
1
UB in Eq.(11)
UB in Eq.(12)
(b) LS, K=100
200
500
800
timestep n
2
9
2
2
25
UB in Eq.(11)
UB in Eq.(12)
(c) CS, K=N
200
500
800
timestep 
k
2
4
24
212
UB in Eq.(11)
UB in Eq.(12)
(d) CS, K=100
Figure 8: The upper bounds (UB) in Eq. (11) and Eq. (12) under full-timesteps (K=N) and 100-
timesteps (K=100) trajectories on CIFAR10 (LS) and CIFAR10 (CS).
To see how these bounds work in practice, in Figure 9, we plot the probability that ˆσ2
n is clipped
by the bounds in Theorem 2 with different number of Monte Carlo samples M on CIFAR10 (LS).
For all M, the curves of ratio v.s. n are similar and the estimate is clipped more frequently when n
is large. This is as expected because when n is large, the gap between the upper bound in Eq. (12)
and the lower bound in Eq. (11) tends to zero. The results also agree with the plot of the bounds in
Figure 7. Besides, the similarity of results between different M implies that the clipping by bounds
occurs mainly due to the error of the score-based model sn(xn), instead of the randomness in Monte
Carlo methods.
0
200
400
600
800
1000
timestep n
0.0
0.2
0.4
0.6
0.8
1.0
ratio
M=1
M=10
M=50
M=100
M=500
M=1000
M=50000
Figure 9: The probability that ˆσ2
n is clipped by the bounds in Theorem 2 with different number of
Monte Carlo samples M on CIFAR10 (LS). The probability is estimated by the ratio of ˆσ2
n being
clipped in 100 independent trials. The results are evaluated with full timesteps K = N.
29

Published as a conference paper at ICLR 2022
G.4
ABLATION STUDY ON THE CLIPPING OF σ2 DESIGNED FOR SAMPLING
This section validates the argument in Appendix F.2 that properly clipping the noise scale σ2 in
p(x1|x2) leads to a better sample quality. As shown in Figure 10 and Figure 11, it greatly improves
the sample quality of our analytic estimate. The curves of clipping and no clipping overlap as K
increases, since σ2 is below the threshold for a large K.
Indeed, as shown in Table 7, the clipping threshold designed for sampling in Appendix F.2 is 1 to 3
orders of magnitude smaller than the combined upper bound in Theorem 2 (i.e., the minimum of the
upper bounds in Eq. (11) and Eq. (12)) when K is small.
As shown in Figure 12, clipping σ2 also slightly improves the sample quality of the handcrafted
reverse variance σ2
n = βn used in the original DDPM (Ho et al., 2020). As for the other two
variances, i.e., σ2
n = ˜βn in the original DDPM and σ2
n = λ2
n = 0 in the original DDIM (Song et al.,
2020a), their σ2 generally don’t exceed the threshold and thereby clipping doesn’t affect the result.
101
102
103
# timesteps K
0
25
50
75
FID 
clipping
no clipping
(a) CIFAR10 (LS)
101
102
103
# timesteps K
0
25
50
75
FID 
clipping
no clipping
(b) CIFAR10 (CS)
101
102
103
# timesteps K
25
50
75
FID 
clipping
no clipping
(c) CelebA 64x64
102
103
# timesteps K
20
30
40
FID 
clipping
no clipping
(d) ImageNet 64x64
Figure 10: Ablation study on clipping σ2, evaluated under Analytic-DDPM.
101
102
103
# timesteps K
0
25
50
75
FID 
clipping
no clipping
(a) CIFAR10 (LS)
101
102
103
# timesteps K
20
40
60
FID 
clipping
no clipping
(b) CIFAR10 (CS)
101
102
103
# timesteps K
20
40
60
FID 
clipping
no clipping
(c) CelebA 64x64
102
103
# timesteps K
20
25
30
FID 
clipping
no clipping
(d) ImageNet 64x64
Figure 11: Ablation study on clipping σ2, evaluated under Analytic-DDIM.
101
102
103
# timesteps K
0
100
200
300
FID 
clipping
no clipping
(a) CIFAR10 (LS)
101
102
103
# timesteps K
0
100
200
FID 
clipping
no clipping
(b) CIFAR10 (CS)
101
102
103
# timesteps K
0
100
200
300
FID 
clipping
no clipping
(c) CelebA 64x64
102
103
# timesteps K
50
100
150
FID 
clipping
no clipping
(d) ImageNet 64x64
Figure 12: Ablation study on clipping σ2, evaluated under DDPM with σ2
n = βn.
30

Published as a conference paper at ICLR 2022
Table 7: Comparing the values of (i) the threshold in Appendix F.2 used to clip σ2
2 designed for sam-
pling, (ii) the combined upper bound in Theorem 2 when n = 2, (iii) the lower bound in Theorem 2
when n = 2 and (iv) our analytic estimate ˆσ2
2. We show comparison results on different datasets and
different forward processes when K is small.
Model \ # timesteps K
10
25
50
100
CIFAR10 (LS)
DDPM
Threshold (y=2)
3.87 × 10−4
3.87 × 10−4
3.87 × 10−4
3.87 × 10−4
Upper bound
1.45 × 10−1
2.24 × 10−2
6.20 × 10−3
2.10 × 10−3
Lower bound
9.99 × 10−5
9.96 × 10−5
9.84 × 10−5
9.55 × 10−5
ˆσ2
2
8.70 × 10−3
2.99 × 10−3
1.32 × 10−3
6.54 × 10−4
DDIM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
1.37 × 10−1
1.96 × 10−2
4.82 × 10−3
1.36 × 10−3
Lower bound
0
0
0
0
ˆσ2
2
8.17 × 10−3
2.54 × 10−3
9.66 × 10−4
3.73 × 10−4
CIFAR10 (CS)
DDPM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
3.56 × 10−2
6.15 × 10−3
1.85 × 10−3
6.80 × 10−4
Lower bound
4.12 × 10−5
4.10 × 10−5
4.04 × 10−5
3.89 × 10−5
ˆσ2
2
3.90 × 10−3
1.28 × 10−3
5.61 × 10−4
2.75 × 10−4
DDIM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
3.33 × 10−2
5.22 × 10−3
1.37 × 10−3
4.18 × 10−4
Lower bound
0
0
0
0
ˆσ2
2
3.61 × 10−3
1.06 × 10−3
3.95 × 10−4
1.53 × 10−4
CelebA 64x64
DDPM
Threshold (y=2)
3.87 × 10−4
3.87 × 10−4
3.87 × 10−4
3.87 × 10−4
Upper bound
1.45 × 10−1
2.24 × 10−2
6.20 × 10−3
2.10 × 10−3
Lower bound
9.99 × 10−5
9.96 × 10−5
9.84 × 10−5
9.55 × 10−5
ˆσ2
2
4.04 × 10−3
1.54 × 10−3
7.54 × 10−4
4.06 × 10−4
DDIM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
1.37 × 10−1
1.96 × 10−2
4.82 × 10−3
1.36 × 10−3
Lower bound
0
0
0
0
ˆσ2
2
3.74 × 10−3
1.26 × 10−3
5.17 × 10−4
2.11 × 10−4
Model \ # timesteps K
25
50
100
200
ImageNet 64x64
DDPM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
5.93 × 10−3
1.84 × 10−3
6.44 × 10−4
2.61 × 10−4
Lower bound
9.85 × 10−6
9.81 × 10−6
9.72 × 10−6
9.51 × 10−6
ˆσ2
2
1.40 × 10−3
6.05 × 10−4
2.77 × 10−4
1.39 × 10−4
DDIM
Threshold (y=1)
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
9.66 × 10−5
Upper bound
5.46 × 10−3
1.59 × 10−3
5.03 × 10−4
1.77 × 10−4
Lower bound
0
0
0
0
ˆσ2
2
1.28 × 10−3
5.17 × 10−4
2.12 × 10−4
9.11 × 10−5
31

Published as a conference paper at ICLR 2022
G.5
SAMPLE QUALITY COMPARISON BETWEEN DIFFERENT TRAJECTORIES
While the optimal trajectory (OT) signiﬁcantly improves the likelihood results, it doesn’t lead to
better FID results. As shown in Figure 13, the even trajectory (ET) has better FID results. Such
a behavior essentially roots in the different natures of the two metrics and has been investigated in
extensive prior works (Ho et al., 2020; Nichol & Dhariwal, 2021; Song et al., 2021; Vahdat et al.,
2021; Watson et al., 2021; Kingma et al., 2021).
101
102
103
# timesteps K
0
25
50
75
FID 
ET
OT
(a) CIFAR10 (LS)
101
102
103
# timesteps K
20
40
FID 
ET
OT
(b) CIFAR10 (CS)
101
102
103
# timesteps K
20
40
FID 
ET
OT
(c) CelebA 64x64
102
103
# timesteps K
20
40
60
80
FID 
ET
OT
(d) ImageNet 64x64
Figure 13: FID results with ET and OT, evaluated under Analytic-DDPM.
G.6
ADDITIONAL LIKELIHOOD COMPARISON
We compare our Analytic-DPM to Improved DDPM (Nichol & Dhariwal, 2021) that predicts the
reverse variance by a neural network. The comparison is based on the ImageNet 64x64 model
described in Appendix F.1. As shown in Table 8, with full timesteps, Analytic-DPM achieves a
NLL of 3.61, which is very close to 3.57 achieved by predicting the reverse variance in Improved
DDPM. Besides, we also notice that the ET reduces the log-likelihood performance of Improved
DDPM when K is small, and this is consistent with what Nichol & Dhariwal (2021) report. In
contrast, our Analytic-DPM performs well with the ET.
Table 8: Negative log-likelihood (bits/dim) ↓under the DDPM forward process on ImageNet 64x64.
All are evaluated under the even trajectory (ET).
Model \ # timesteps K
25
50
100
200
400
1000
4000
Improved DDPM
18.91
8.46
5.27
4.24
3.86
3.68
3.57
Analytic-DDPM
4.78
4.42
4.15
3.95
3.81
3.69
3.61
G.7
CELEBA 64X64 RESULTS WITH A SLIGHTLY DIFFERENT IMPLEMENTATION OF THE
EVEN TRAJECTORY
Song et al. (2020a) use a slightly different implementation of the even trajectory on CelebA 64x64.
They choose a different stride a = int( N
K ), and the kth timestep is determined as 1 + a(k −1). As
shown in Table 9, under the setting of Song et al. (2020a) on CelebA 64x64, our Analytic-DPM still
improves the original DDIM consistently and improves the original DDPM in most cases.
G.8
COMPARISON TO OTHER CLASSES OF GENERATIVE MODELS
While DPMs and their variants serve as the most direct baselines to validate the effectiveness of
our method, we also compare with other classes of generative models in Table 10. Analytic-DPM
achieves competitive sample quality results among various generative models, and meanwhile sig-
niﬁcantly reduces the efﬁciency gap between DPMs and other models.
32

Published as a conference paper at ICLR 2022
Table 9: FID ↓on CelebA 64x64, following the even trajectory implementation of Song et al.
(2020a). †Original results in Song et al. (2020a). ‡Our reproduced results.
Model \ # timesteps K
10
20
50
100
1000
CelebA 64x64
DDPM, σ2
n = ˜βn†
33.12
26.03
18.48
13.93
5.98
DDPM, σ2
n = ˜βn‡
33.13
25.95
18.61
13.92
5.95
DDPM, σ2
n = βn†
299.71
183.83
71.71
45.20
3.26
DDPM, σ2
n = βn‡
299.88
185.21
71.86
45.15
3.21
Analytic-DDPM
25.88
17.40
10.98
7.95
5.21
DDIM, σ2
n = λ2
n = 0†
17.33
13.73
9.17
6.53
3.51
DDIM, σ2
n = λ2
n = 0‡
17.38
13.72
9.17
6.51
3.40
Analytic-DDIM
12.74
9.50
5.96
4.14
3.13
Table 10: Comparison to other classes of generative models on CIFAR10. We show the FID results,
the number of model function evaluations (NFE) to generate a single sample and the time to generate
10 samples with a batch size of 10 on one GeForce RTX 2080 Ti.
Method
FID↓
NFE ↓
Time (s) ↓
Analytic-DPM, K = 25 (ours)
5.81
25
0.73
DDPM, K = 90 (Ho et al., 2020)
6.12
90
2.64
DDIM, K = 30 (Song et al., 2020a)
5.85
30
0.88
Improved DDPM, K = 45 (Nichol & Dhariwal, 2021)
5.96
45
1.37
SNGAN (Miyato et al., 2018)
21.7
1
-
BigGAN (cond.) (Brock et al., 2018)
14.73
1
-
StyleGAN2 (Karras et al., 2020a)
8.32
1
-
StyleGAN2 + ADA (Karras et al., 2020a)
2.92
1
-
NVAE (Vahdat & Kautz, 2020)
23.5
1
-
Glow (Kingma & Dhariwal, 2018)
48.9
1
-
EBM (Du & Mordatch, 2019)
38.2
60
-
VAEBM (Xiao et al., 2020)
12.2
16
-
33

Published as a conference paper at ICLR 2022
G.9
SAMPLES
In Figure 14-17, we show Analytic-DDIM constrained on a short trajectory of K = 50 timesteps
can generate samples comparable to these under the best FID setting.
In Figure 18-21, we also show samples of both Analytic-DDPM and Analytic-DDIM constrained
on trajectories of different number of timesteps K.
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 14: Generated samples on CIFAR10 (LS).
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 15: Generated samples on CIFAR10 (CS).
34

Published as a conference paper at ICLR 2022
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 16: Generated samples on CelebA 64x64.
(a) Best FID samples
(b) Analytic-DDIM, K = 50
Figure 17: Generated samples on ImageNet 64x64.
35

Published as a conference paper at ICLR 2022
(a) Analytic-DDPM, K = 10
(b) Analytic-DDPM, K = 100
(c) Analytic-DDPM, K = 1000
(d) Analytic-DDIM, K = 10
(e) Analytic-DDIM, K = 100
(f) Analytic-DDIM, K = 1000
Figure 18: Generated samples on CIFAR10 (LS).
(a) Analytic-DDPM, K = 10
(b) Analytic-DDPM, K = 100
(c) Analytic-DDPM, K = 1000
(d) Analytic-DDIM, K = 10
(e) Analytic-DDIM, K = 100
(f) Analytic-DDIM, K = 1000
Figure 19: Generated samples on CIFAR10 (CS).
36

Published as a conference paper at ICLR 2022
(a) Analytic-DDPM, K = 10
(b) Analytic-DDPM, K = 100
(c) Analytic-DDPM, K = 1000
(d) Analytic-DDIM, K = 10
(e) Analytic-DDIM, K = 100
(f) Analytic-DDIM, K = 1000
Figure 20: Generated samples on CelebA 64x64.
(a) Analytic-DDPM, K = 25
(b) Analytic-DDPM, K = 200
(c) Analytic-DDPM, K = 4000
(d) Analytic-DDIM, K = 25
(e) Analytic-DDIM, K = 200
(f) Analytic-DDIM, K = 4000
Figure 21: Generated samples on ImageNet 64x64.
37

Published as a conference paper at ICLR 2022
H
ADDITIONAL DISCUSSION
H.1
THE EXTRA COST OF THE MONTE CARLO ESTIMATE
The extra cost of the Monte Carlo estimate Γ is small compared to the whole inference cost. In fact,
the Monte Carlo estimate requires MN additional model function evaluations. During inference,
suppose we generate M1 samples or calculate the log-likelihood of M1 samples with K timesteps.
Both DPMs and Analytic-DPMs need M1K model function evaluations. Employing the same score-
based models, the relative additional cost of Analytic-DPM is
MN
M1K . As shown in Appendix G.2,
a very small M (e.g., M = 10, 100) is sufﬁcient for Analytic-DPM, making the relative additional
cost small if not negligible. For instance, on CIFAR10, let M = 10, N = 1000, M1 = 50000 and
K ≥10, we obtain
MN
M1K ≤0.02 and Analytic-DPM still consistently improves the baselines as
presented in Table 6.
Further, the additional calculation of the Monte Carlo estimate occurs only once given a pretrained
model and training dataset, since we can save the results of Γ = (Γ1, · · · , ΓN) in Eq.(8) and reuse
it among different inference settings (e.g., trajectories of various K). The reuse is valid, because the
marginal distribution of a shorter forward process q(x0, xτ1, · · · , xτK) at timestep τk is the same as
that of the full-timesteps forward process q(x0:N) at timestep n = τk. Indeed, in our experiments
(e.g., Table 1,2), Γ is shared across different selections of K, trajectories and forward processes.
Moreover, in practice, Γ can be calculated ofﬂine and deployed together with the pretrained model
and the online inference cost of Analytic-DPM is exactly the same as DPM.
H.2
THE STOCHASTICITY OF THE VARIATIONAL BOUND AFTER PLUGGING THE ANALYTIC
ESTIMATE
In this part, we write Lvb as Lvb(σ2
n) to emphasize its dependence on the reverse variance σ2
n.
When calculating the variational bound Lvb(σ2
n) (i.e., the negative ELBO) of Analytic-DPM, we
will plug ˆσ2
n into the variational bound and get Lvb(ˆσ2
n). Since ˆσ2
n is calculated by the Monte Carlo
method, Lvb(ˆσ2
n) is a stochastic variable. A natural question is that whether Lvb(ˆσ2
n) is a stochastic
bound of Lvb(E[ˆσ2
n]), which can be judged by the Jensen’s inequality if Lvb is convex or concave.
However, this is generally not guaranteed, as stated in Proposition 2.
Proposition 2. Lvb(σ2
n) is neither convex nor concave w.r.t. σ2
n.
Proof. Since σ2
n only inﬂuences the n-th term Ln in the variational bound Lvb, where
Ln =

EqDKL(q(xn−1|xn, x0)||p(xn−1|xn))
2 ≤n ≤N
−Eq log p(x0|x1)
n = 1
,
we only need to study the convexity of Ln w.r.t. σ2
n.
When 2 ≤n ≤N,
Ln = d
2
λ2
n
σ2n
−1 + log σ2
n
λ2n
+ 1
σ2n
Eq
||˜µ(xn, x0) −µn(xn)||2
d

.
Let A = λ2
n + Eq
|| ˜µ(xn,x0)−µn(xn)||2
d
, then Ln as a function of σ2
n is convex when 0 < σ2
n < 2A
and concave when 2A < σ2
n. Thereby, Lvb(σ2
n) is neither convex nor concave w.r.t. σ2
n.
Nevertheless, in this paper, Lvb(ˆσ2
n) is a stochastic upper bound of Lvb(σ∗2
n ) because Lvb(σ∗2
n ) is
the optimal. The bias of Lvb(ˆσ2
n) w.r.t. Lvb(σ∗2
n ) is due to the Monte Carlo method as well as
the error of the score-based model. The former can be reduced by increasing the number of Monte
Carlo samples. The latter is irreducible if the pretrained model is ﬁxed, which motivates us to clip
the estimate, as discussed in Section 3.1.
H.3
COMPARISON TO OTHER GAUSSIAN MODELS AND THEIR RESULTS
The reverse process of DPMs is a Markov process with Gaussian transitions. Thereby, it is inter-
esting to compare it with other Gaussian models, e.g., the expectation propagation (EP) with the
Gaussian process (GP) (Kim & Ghahramani, 2006).
38

Published as a conference paper at ICLR 2022
Both EP and Analytic-DPM use moment matching as a key step to ﬁnd analytic solutions of
DKL(ptarget||popt) terms. However, to our knowledge, the relation between moment matching
and DPMs has not been revealed in prior literature. Further, compared to EP, we emphasize that it
is highly nontrivial to calculate the second moment of ptarget in DPMs because ptarget involves an
unknown and potentially complicated data distribution.
In EP with GP (Kim & Ghahramani, 2006), ptarget is the product of a single likelihood factor and all
other approximate factors for tractability. In fact, the form of the likelihood factor is chosen such that
the ﬁrst two moments of ptarget can be easily computed or approximated. For instance, the original
EP (Minka, 2001) considers Gaussian mixture likelihood (or Bernoulli likelihood for classiﬁcation)
and the moments can be directed obtained by the properties of Gaussian (or integration by parts).
Besides, at the cost of the tractability, there is no converge guarantee of EP in general.
In contrast, ptarget in this paper is the conditional distribution q(xn−1|xn) of the corresponding
joint distribution q(x0:N) deﬁned by the forward process. Note that the moments of q(xn−1|xn) are
nontrivial to calculate because it involves an unknown and potentially complicated data distribution.
Technically, in Lemma 13, we carefully use the law of total variance conditioned on x0 and convert
the second moment of q(xn−1|xn) to that of q(x0|xn), which surprisingly can be expressed as the
score function as proven in Lemma 11.
H.4
FUTURE WORKS
In our work, we mainly focus on image data. It would be interesting to apply Analytic-DPM to other
data modalities, e.g. speech data (Chen et al., 2020). As presented in Appendix E, our method can be
applied to continuous DPMs, e.g., variational diffusion models (Kingma et al., 2021) that learn the
forward noise schedule. It is appealing to see how Analytic-DPM works on these continuous DPMs.
Finally, it is also interesting to incorporate the optimal reverse variance in the training process of
DPMs.
39

